<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ì›”ê°„ ìŠ¤ì¼€ì¤„</title>
<style>
  /* ===== ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ===== */
  html, body { height:100%; margin:0; overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; color:#222; }
  .nav{ background:#2c3e50; color:#fff; padding:10px; display:flex; justify-content:flex-end; gap:10px; position:sticky; top:0; z-index:1000; }
  .nav button{ background:#fff; color:#000; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; }

  #top-bar{ background:#f0f0f0; border-bottom:1px solid #ddd; padding:8px 15px; display:flex; align-items:center; gap:10px; position:sticky; top:0; z-index:900; }
  #top-bar h1{ font-size:18px; margin:0; }
  #top-bar select, #top-bar button{ padding:5px 10px; font-size:14px; border:1px solid #dcdcdc; border-radius:8px; background:#fff; }
  #status{ color:#666; font-size:13px; margin-left:4px; }

  .page{ overflow:auto; padding:12px 14px 16px; box-sizing:border-box; height:calc(100vh - 96px); }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

  .card{ border:1px solid #e5e7eb; border-radius:12px; overflow:visible; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04); }
  .teambar{ background:#e9eef5; border-bottom:1px solid #dbe2ea; color:#1f2937; font-size:12px; font-weight:700; letter-spacing:.2px; padding:8px 12px; }

  /* ===== í‘œ ê¸°ë³¸ ===== */
  .table-wrap{ overflow:visible; }              /* ì¹´ë“œ ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì œê±° */
  table{
    border-collapse:collapse;                   /* ê²¹ì¹˜ëŠ” í…Œë‘ë¦¬ ë°©ì§€(ë‹¨ì¼ì„ ) */
    width:100%; table-layout:fixed;
    --row-h: 26px;                              /* ê¸°ë³¸ ì½˜í…ì¸  í–‰ ë†’ì´ */
    --weeknum-h: 10px;                          /* ë‚ ì§œ ìˆ«ì ì¤„ ë†’ì´ */
    --weeknum-font: 8px;                        /* ë‚ ì§œ ìˆ«ì í°íŠ¸ */
    --weeknum-pad-v: 1px;
    --weeknum-pad-h: 3px;
  }
  tbody tr{ height: var(--row-h); }

  /* ë‚ ì§œ(ìˆ«ì) ì¤„ */
  tr[data-weekrow="1"]{ height: var(--weeknum-h); }
  tr[data-weekrow="1"] td{
    text-align:center;
    padding: var(--weeknum-pad-v) var(--weeknum-pad-h);
    font-size: var(--weeknum-font);
    line-height:1;
  }

  td{
    border:1px solid #e6e6e6;                   /* ëª¨ë“  ì…€ ë‹¨ì¼ í…Œë‘ë¦¬ */
    padding:3px 6px;
    vertical-align:top;
    word-break:break-word;
    font-size:12px;
    line-height:1.15;
    overflow:hidden;                             /* ì…€ì€ ì ˆëŒ€ í–‰ ë†’ì´ë¥¼ ë°€ì–´ì˜¬ë¦¬ì§€ ì•ŠìŒ */
    height:100%;
    box-sizing:border-box;
  }
  /* ë‚´ìš© ë˜í¼(ë„˜ì¹¨ ê°ì§€/ì¶•ì†Œìš©) */
  td > .cell{
    display:block; height:100%; overflow:hidden;
  }
</style>
</head>
<body>
  <div class="nav" id="nav">
    <button onclick="location.href='index.html'">í™ˆ</button>
    <button onclick="location.href='monthly.html'">ì›”ë³„ ëŒ€ìƒì²˜ ë¦¬ìŠ¤íŠ¸</button>
    <button onclick="location.href='map.html'">ì§€ë„ ë³´ê¸°</button>
    <button onclick="location.href='schedule.html'">ìŠ¤ì¼€ì¤„</button>
  </div>

  <div id="top-bar">
    <h1>ì›”ê°„ ìŠ¤ì¼€ì¤„</h1>
    <label for="sheetSelect"><strong>ì›” ì„ íƒ:</strong></label>
    <select id="sheetSelect"></select>
    <button id="refreshBtn">ìƒˆë¡œê³ ì¹¨</button>
    <span id="status"></span>
  </div>

  <div class="page" id="page">
    <div id="grid" class="grid"></div>
  </div>

<script>
  /* ===== ì˜µì…˜ ===== */
  const MIN_FONT_PX = 9;       // ê¸€ì ìµœì†Œ í¬ê¸° (ê³¼ë„í•œ ì¶•ì†Œ ë°©ì§€)
  const MAX_FONT_PX = 12;

  /* ===== ë ˆì´ì•„ì›ƒ ===== */
  function relayout(){
    const nav  = document.getElementById('nav');
    const top  = document.getElementById('top-bar');
    const page = document.getElementById('page');
    const navH = nav ? nav.offsetHeight : 0;
    const topH = top ? top.offsetHeight : 0;
    top.style.top = navH + 'px';
    page.style.height = `calc(100vh - ${navH + topH}px)`;
  }
  window.addEventListener('load', relayout);
  window.addEventListener('resize', () => {
    relayout();
    unifyWeeksByMax();     // ë·°í¬íŠ¸ ë³€ê²½ ì‹œì—ë„ ì£¼ ë†’ì´ ì¬ê³„ì‚°
  });

  /* ===== ë°ì´í„° ===== */
  const api = (qs) => `/api/schedule${qs ? ('?' + qs) : ''}`;
  const $select  = document.getElementById('sheetSelect');
  const $refresh = document.getElementById('refreshBtn');
  const $grid    = document.getElementById('grid');
  const $status  = document.getElementById('status');

  const now = new Date();
  const initMonth = (now.getMonth() + 1) + 'ì›”';
  let renderAborter = null;
  let changeTimer = null;

  init().catch(showError);

  async function init(){
    // ì‹œíŠ¸ ëª©ë¡(5ë¶„ ìºì‹œ)
    let sheets = null;
    try{
      const cached = JSON.parse(sessionStorage.getItem('sheets:v1') || 'null');
      if (cached && Date.now() - cached.t < 5*60*1000) sheets = cached.list;
    }catch(_){}
    if (!sheets) {
      const j = await fetchJsonRetry(api('mode=sheets'));
      sheets = j.sheets || [];
      sessionStorage.setItem('sheets:v1', JSON.stringify({ t: Date.now(), list: sheets }));
    }

    $select.innerHTML = sheets.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join('');
    $select.value = sheets.includes(initMonth) ? initMonth : (sheets[0] || '1ì›”');

    await render($select.value);

    $select.addEventListener('change', () => {
      clearTimeout(changeTimer);
      changeTimer = setTimeout(() => render($select.value), 250);
    });
    $refresh.addEventListener('click', () => render($select.value));
  }

  async function render(sheetName){
    if (renderAborter) renderAborter.abort();
    renderAborter = new AbortController();
    try{
      setLoading(`${sheetName} ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦`);
      const data = await fetchJsonRetry(
        api(new URLSearchParams({ mode:'month', sheet: sheetName }).toString()),
        { signal: renderAborter.signal }
      );
      if(!data.ok) throw new Error(data.error || 'API ì˜¤ë¥˜');

      $grid.innerHTML = '';
      const year = data.year || (new Date()).getFullYear();
      for(const team of data.teams){
        $grid.appendChild(renderTeam(team, { sheetName, year }));
      }
      setLoading('');
      relayout();

      // ìˆœì„œ ì¤‘ìš”: í–‰ ë Œë” â†’ í°íŠ¸ ì´ˆê¸°í™”/ì¶•ì†Œ â†’ ì£¼ ë†’ì´ í†µì¼
      resetFonts();
      shrinkAllText();
      unifyWeeksByMax();
    }catch(e){
      if (e.name === 'AbortError') return;
      showError(e);
    }
  }

  /* ===== ë„¤íŠ¸ì›Œí¬ ìœ í‹¸ ===== */
  async function fetchJsonRetry(url, { retries = 5, signal } = {}){
    let attempt = 0;
    while (true){
      try{
        const r = await fetch(url, { cache:'no-store', signal });
        if (r.ok) return r.json();
        if (r.status === 429 || r.status === 503){
          attempt++;
          if (attempt > retries) throw new Error(`HTTP ${r.status}`);
          const wait = Math.min(30000, 500 * Math.pow(2, attempt-1) + Math.random()*500);
          setLoading(`ìš”ì²­ í•œë„(HTTP ${r.status})â€¦ ${Math.round(wait/1000)}ì´ˆ í›„ ì¬ì‹œë„`);
          await new Promise(res => setTimeout(res, wait));
          continue;
        }
        throw new Error(`HTTP ${r.status}`);
      }catch(e){
        if (e.name === 'AbortError') throw e;
        attempt++;
        if (attempt > retries) throw e;
        const wait = Math.min(30000, 500 * Math.pow(2, attempt-1) + Math.random()*500);
        setLoading(`ë„¤íŠ¸ì›Œí¬ ì¬ì‹œë„ ì¤‘â€¦ ${Math.round(wait/1000)}ì´ˆ`);
        await new Promise(res => setTimeout(res, wait));
      }
    }
  }

  /* ===== ë Œë” ìœ í‹¸ ===== */
  function parseMonth(sheetName){
    const m = parseInt(String(sheetName).replace(/\D+/g,''),10);
    return isNaN(m) ? (new Date().getMonth()+1) : m;
  }
  function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); }
  function dowKR(y,m,d){ return ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(y, m-1, d).getDay()]; }

  function isGrayColor(c){
    if(!c) return false;
    c = String(c).trim().toLowerCase();
    const common = ['#fff','#ffffff','#eee','#e6e6e6','#e5e7eb','#f0f0f0','#dddddd','#dcdcdc','#ececec','#efefef','#e9eef5','#f3f4f6','#e0e0e0','#cccccc','white','transparent'];
    if(common.some(x => c.startsWith(x))) return true;
    const m = c.match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
    if(m){
      const r=+m[1], g=+m[2], b=+m[3];
      const avg = (r+g+b)/3, maxDiff = Math.max(Math.abs(r-avg), Math.abs(g-avg), Math.abs(b-avg));
      return avg >= 235 || (avg >= 200 && maxDiff <= 10);
    }
    return false;
  }

  /* ğŸ”¸ ë¹¨ê°„(ì‚¬ëŒì´ë¦„/ì—°ì°¨ ë“±) ë°°ê²½ íŒë³„: ë°´ë“œ í–‰ êµ¬ë¶„ìš© */
  function isRedishColor(c){
    if(!c) return false;
    c = String(c).trim().toLowerCase();
    const quick = ['#f4cccc','#f8d7da','#ffe5e5','#ffd6d6','#fdd','salmon','lightcoral','mistyrose'];
    if (quick.includes(c)) return true;
    const hx = c.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
    if (hx){
      let h = hx[1]; if (h.length===3) h = h.split('').map(x=>x+x).join('');
      const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
      return (r - Math.max(g,b) >= 30) && r >= 140;
    }
    const rgb = c.match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
    if (rgb){
      const r=+rgb[1], g=+rgb[2], b=+rgb[3];
      return (r - Math.max(g,b) >= 30) && r >= 140;
    }
    return false;
  }

  function visibleText(cell){
    if(cell?.html){
      return String(cell.html).replace(/<br\s*\/?>/gi,' ')
                              .replace(/&nbsp;/gi,' ')
                              .replace(/<[^>]*>/g,'')
                              .trim();
    }
    return String(cell?.text ?? '').trim();
  }

  // "ì‘ì€ ë‚ ì§œ ìˆ«ì" ì¤„ ê°ì§€
  function isWeekNumberRow(rowCells, cols){
    let countDigits = 0, countCells = 0;
    for(let c=0; c<cols; c++){
      const cell = rowCells[c];
      if(cell === 'skip') continue;
      countCells++;
      const t = visibleText(cell);
      if(/^\d{1,2}$/.test(t)) countDigits++;
    }
    return countDigits >= Math.max(5, Math.floor(cols*0.6));
  }

  /* ===== íŒ€ ì¹´ë“œ ë Œë” ===== */
  function renderTeam(team, { sheetName, year } = {}){
    const card = document.createElement('section'); card.className = 'card';
    const bar  = document.createElement('div'); bar.className = 'teambar'; bar.textContent = `${team.id}íŒ€`; card.appendChild(bar);

    const wrap  = document.createElement('div'); wrap.className = 'table-wrap';
    const table = document.createElement('table');

    const month    = parseMonth(sheetName);
    const lastDay  = daysInMonth(year, month);
    const firstDow = new Date(year, month-1, 1).getDay();

    let dayCounter = 1;
    let weekIdx    = -1;

    // ë³‘í•© ë°˜ì˜ ê·¸ë¦¬ë“œ
    const grid = Array.from({length: team.rows}, () => Array(team.cols).fill(null));
    for (const cell of team.cells){
      const r0 = cell.r - 1, c0 = cell.c - 1;
      grid[r0][c0] = cell;
      const rs = cell.rowspan || 1, cs = cell.colspan || 1;
      for (let r=r0; r<r0+rs; r++){
        for (let c=c0; c<c0+cs; c++){
          if (r===r0 && c===c0) continue;
          grid[r][c] = 'skip';
        }
      }
    }

    for (let r=0; r<team.rows; r++){
      const tr = document.createElement('tr');
      const weekNumberRow = isWeekNumberRow(grid[r], team.cols);
      if (weekNumberRow) { weekIdx++; tr.dataset.weekrow = '1'; }

      // âœ… ì´ í–‰ì˜ ì—­í• ì„ ì¶”ì : schedule(ì¼ì •) / band(ë¹¨ê°„) / empty
      let rowKind = 'empty';

      for (let c=0; c<team.cols; c++){
        const cell = grid[r][c];
        if (cell === 'skip') continue;

        const td = document.createElement('td');

        if (cell){
          if (cell.rowspan > 1) td.rowSpan = cell.rowspan;
          if (cell.colspan > 1) td.colSpan = cell.colspan;
          if (cell.bg) td.style.backgroundColor = cell.bg;

          const textNow = visibleText(cell);

          // ğŸ”¸ ì£¼ ìˆ«ìì¤„ì´ ì•„ë‹ˆë¼ë©´, ì´ í–‰ì´ 'ë°´ë“œ'ì¸ì§€ 'ìŠ¤ì¼€ì¤„'ì¸ì§€ ì²´í¬
          if (!weekNumberRow){
            if (textNow){
              if (isRedishColor(cell.bg)) rowKind = 'band';
              else if (rowKind !== 'band') rowKind = 'schedule';
            }
          }

          if (weekNumberRow){
            if (/^\d{1,2}$/.test(textNow)){
              const pos     = (weekIdx * 7) + c - firstDow + 1;
              const inMonth = (pos >= 1 && pos <= lastDay);
              let dow;
              if (inMonth) dow = new Date(year, month-1, pos).getDay();
              else if (pos < 1) { const prevLast = daysInMonth(year, month-1); dow = new Date(year, month-2, prevLast + pos).getDay(); }
              else { dow = new Date(year, month, pos - lastDay).getDay(); }

              td.textContent   = textNow;
              td.style.fontWeight = inMonth ? '700' : '600';
              td.style.color = inMonth ? (dow === 0 ? '#d11' : (dow === 6 ? '#1d4ed8' : '#111827')) : '#9ca3af';
            }else{
              if (cell.html && textNow !== '') td.innerHTML = cell.html;
              else { if (cell.fc) td.style.color = cell.fc; td.textContent = textNow; }
            }

          } else {
            if (cell.html && textNow !== '') td.innerHTML = cell.html;
            else { if (cell.fc) td.style.color = cell.fc; td.textContent = textNow; }

            // ì „í­ íšŒìƒ‰ + ë¹„ì–´ìˆìŒ â†’ 'Nì¼(ìš”ì¼)' ìë™ í‘œê¸°
            const colspan = cell.colspan || 1;
            const looksEmpty = (textNow === '');
            const nearFullWidth = (team.cols - colspan) <= 1;
            if (looksEmpty && nearFullWidth && isGrayColor(cell.bg)){
              if (dayCounter <= lastDay){
                td.textContent = `${dayCounter}ì¼(${dowKR(year, month, dayCounter)})`;
                td.style.fontWeight = '700';
              }
              dayCounter++;
            }
          }

        } else {
          td.textContent = '';
        }

        // ë‚´ìš©ì€ ë˜í¼ì— ë„£ì–´ ë†’ì´ ì¦ê°€ ì°¨ë‹¨ + ì¶•ì†Œìš©
        wrapCellContent(td);
        tr.appendChild(td);
      }

      // ğŸ”¸ ì£¼ ìˆ«ìì¤„ì´ ì•„ë‹ˆë©´, ì´ í–‰ì˜ ì—­í•  ë¼ë²¨ì„ ì €ì¥
      if (!weekNumberRow) tr.dataset.kind = rowKind;

      table.appendChild(tr);
    }

    wrap.appendChild(table);
    card.appendChild(wrap);
    return card;
  }

  function wrapCellContent(td){
    if (td.querySelector(':scope > .cell')) return;
    const wrapper = document.createElement('div');
    wrapper.className = 'cell';
    while (td.firstChild) wrapper.appendChild(td.firstChild);
    td.appendChild(wrapper);
  }

  /* ===== í°íŠ¸ ì´ˆê¸°í™”/ì¶•ì†Œ ===== */
  function resetFonts(){
    document.querySelectorAll('.table-wrap table td .cell').forEach(cell => {
      cell.style.fontSize  = MAX_FONT_PX + 'px';
      cell.style.lineHeight = '1.15';
    });
  }
  function shrinkAllText(){
    document.querySelectorAll('.table-wrap table tr:not([data-weekrow="1"]) td .cell').forEach(el => shrinkToFit(el, MIN_FONT_PX));
  }
  function shrinkToFit(el, minPx){
    if (!el.textContent.trim() && el.children.length === 0) return;
    let fs = parseFloat(getComputedStyle(el).fontSize) || MAX_FONT_PX;
    for (let i=0; i<10; i++){
      const fitsH = el.scrollHeight <= el.clientHeight;
      const fitsW = el.scrollWidth  <= el.clientWidth;
      if (fitsH && fitsW) break;
      const hRatio = el.clientHeight / Math.max(el.scrollHeight, 1);
      const wRatio = el.clientWidth  / Math.max(el.scrollWidth, 1);
      const ratio  = Math.max(0.5, Math.min(hRatio, wRatio)) * 0.98;
      const next = Math.max(minPx, Math.floor(fs * ratio));
      if (next >= fs) break;
      fs = next;
      el.style.fontSize = fs + 'px';
      el.style.lineHeight = (0.95 + (fs - minPx) * 0.02).toFixed(2);
      if (fs <= minPx) break;
    }
  }

  /* ===== ì£¼ê°„ ê°„ê²© â€œìŠ¤ì¼€ì¤„ í–‰ë§Œ í†µì¼â€ =====
     - ê° ì£¼ì˜ í–‰ë“¤ ì¤‘ data-kind="schedule" ë§Œ ëª¨ìŒ
     - ê·¸ ì£¼ë“¤ì˜ ìŠ¤ì¼€ì¤„ ì´ë†’ì´ ì¤‘ ìµœëŒ€ê°’ì„ targetìœ¼ë¡œ ì‚¬ìš©
     - ê° ì£¼ì—ì„œ ìŠ¤ì¼€ì¤„ í–‰ë§Œ ê· ì¼ ë¶„ë°°(ë°´ë“œ í–‰ì€ ì›ë˜ ë†’ì´ ìœ ì§€)
  */
  function unifyWeeksByMax(){
    document.querySelectorAll('.table-wrap table').forEach(tbl => {
      const rows = Array.from(tbl.querySelectorAll('tr'));
      if (rows.length === 0) return;

      // ë‚ ì§œì¤„ ì¸ë±ìŠ¤
      let weekIdxs = rows.map((tr,i)=> tr.dataset.weekrow==='1' ? i : -1).filter(i=>i>=0);
      if (weekIdxs.length === 0) return;

      // ì£¼ë³„ ìŠ¤ì¼€ì¤„í–‰ë§Œ ì§‘ê³„
      const blocks = weekIdxs.map((start, wIdx) => {
        const end = (wIdx+1 < weekIdxs.length) ? weekIdxs[wIdx+1] : rows.length;
        const contentRows  = rows.slice(start+1, end);
        const scheduleRows = contentRows.filter(tr => tr.dataset.kind === 'schedule');
        const schedHeight  = scheduleRows.reduce((s,tr)=> s + tr.getBoundingClientRect().height, 0);
        return { scheduleRows, schedHeight };
      });

      const target = Math.max(...blocks.map(b => b.schedHeight), 0) | 0;
      if (!isFinite(target) || target <= 0) return;

      // ì£¼ë³„ë¡œ "ìŠ¤ì¼€ì¤„ í–‰"ë§Œ ê· ì¼ ë¶„ë°°(+ë°˜ì˜¬ë¦¼ ì˜¤ì°¨ ë§ˆì§€ë§‰ í–‰ì—)
      blocks.forEach(({scheduleRows}) => {
        if (scheduleRows.length === 0) return;
        const base = Math.max(10, Math.floor(target / scheduleRows.length));
        scheduleRows.forEach(tr => {
          tr.style.height = base + 'px';
          tr.querySelectorAll('td').forEach(td => td.style.height = '100%');
        });
        const used = base * scheduleRows.length;
        const leftover = target - used;
        if (leftover !== 0){
          const last = scheduleRows[scheduleRows.length - 1];
          last.style.height = (base + leftover) + 'px';
        }
      });
    });
  }

  /* ===== ê³µí†µ ===== */
  function setLoading(msg){ $status.textContent = msg || ''; }
  function showError(e){ console.error(e); setLoading(`ì˜¤ë¥˜: ${e?.message || e}`); }
  function esc(s){
    const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
    return String(s).replace(/[&<>"']/g, ch => map[ch]);
  }
</script>
</body>
</html>
