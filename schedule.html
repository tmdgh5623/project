<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>월간 스케줄</title>
  <style>
    /* ───────── 기본/공통 스타일 (기존 페이지 톤과 동일) ───────── */
    :root{
      --bg:#ffffff;
      --ink:#222;
      --muted:#6b7280;
      --bar:#2c3e50;
      --border:#d9d9d9;
      --card:#fff;
      --shadow:0 2px 8px rgba(0,0,0,.04);
      --radius:12px;
      --gap:16px;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif}
    a{color:inherit;text-decoration:none}

    /* 상단 공통 네비 (월별/지도 페이지와 동일 형태) */
    .topbar{
      background:var(--bar); color:#fff; padding:10px;
      display:flex; justify-content:flex-end; gap:10px
    }
    .topbar button{
      background:#fff; color:#000; border:none; border-radius:4px;
      padding:6px 12px; cursor:pointer
    }

    .wrap{max-width:1280px;margin:20px auto;padding:0 16px}

    /* 상단 도구줄 */
    .toolbar{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px
    }
    .toolbar h1{font-size:20px;margin:0;margin-right:8px}
    .toolbar label{color:var(--muted)}
    .toolbar select,.toolbar button{
      border:1px solid var(--border); border-radius:8px; background:#fff;
      padding:8px 10px; font-size:14px
    }
    .toolbar .status{
      margin-left:auto; color:var(--muted); font-size:14px
    }

    /* 팀 2×2 그리드 */
    .grid{
      display:grid; grid-template-columns:1fr 1fr; gap:var(--gap)
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border); border-radius:var(--radius);
      background:var(--card); box-shadow:var(--shadow); overflow:hidden
    }
    .card header{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 12px; border-bottom:1px solid var(--border); background:#fafafa
    }
    .card header h2{margin:0; font-size:16px; font-weight:600}

    .table-wrap{overflow:auto}
    table{width:100%; border-collapse:collapse; table-layout:fixed}
    td{
      border:1px solid #e5e7eb; padding:4px 6px; vertical-align:top;
      font-size:12px; line-height:1.2; word-break:break-word;
      white-space:pre-wrap; /* 줄바꿈 표시 */
      background:#fff; color:#111;
    }
    /* 로딩 숨김/표시 */
    [hidden]{display:none !important}
  </style>
</head>
<body>
  <!-- 상단 공통 네비 -->
  <div class="topbar">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='monthly.html'">월별 대상처 리스트</button>
    <button onclick="location.href='map.html'">지도 보기</button>
    <button onclick="location.href='schedule.html'">스케줄</button>
  </div>

  <div class="wrap">
    <!-- 도구줄: 제목 · 월 선택 · 새로고침 · 상태 -->
    <div class="toolbar">
      <h1>월간 스케줄</h1>

      <label for="sheetSelect"><strong>월 선택:</strong></label>
      <select id="sheetSelect"></select>

      <button id="refreshBtn">새로고침</button>

      <!-- 불러오는 중 메시지를 이 위치에 표시 -->
      <div id="status" class="status" hidden></div>
    </div>

    <!-- 팀 카드들이 들어갈 그리드 -->
    <div id="grid" class="grid" hidden></div>
  </div>

  <script>
    /* 프록시: Vercel의 /api/schedule (GAS_URL로 연결됨) */
    const api = (qs) => `/api/schedule${qs ? ('?' + qs) : ''}`;

    const $select = document.getElementById('sheetSelect');
    const $refresh = document.getElementById('refreshBtn');
    const $grid = document.getElementById('grid');
    const $status = document.getElementById('status');

    const urlQS = new URLSearchParams(location.search);
    const paramSheet = urlQS.get('sheet');

    // 초기화
    init().catch(err => showError(err));

    async function init() {
      // 1) 시트 목록
      const list = await fetchJson(api('mode=sheets')).then(r => r.sheets || []);
      // 2) 현재월 기본값(예: '9월')
      const currentMonth = `${new Date().getMonth() + 1}월`;

      // 드롭다운 구성 (시트 이름 그대로)
      $select.innerHTML = list.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');

      // 쿼리 우선, 없으면 현재월, 그마저 없으면 첫 번째
      let use = list.includes(paramSheet) ? paramSheet
               : list.includes(currentMonth) ? currentMonth
               : (list[0] || '');

      if (use) $select.value = use;

      await renderMonth(use);

      $select.addEventListener('change', () => renderMonth($select.value));
      $refresh.addEventListener('click', () => renderMonth($select.value));
    }

    async function renderMonth(sheetName) {
      try {
        setStatus(`${sheetName} 불러오는 중…`, true);
        $grid.hidden = true;

        const qs = new URLSearchParams({ mode:'month', sheet: sheetName }).toString();
        const data = await fetchJson(api(qs));
        if (!data.ok) throw new Error(data.error || 'API 오류');

        // 그리드 초기화
        $grid.innerHTML = '';

        // 1~4팀 카드 생성
        for (const team of data.teams) {
          $grid.appendChild(renderTeamCard(team));
        }

        setStatus('', false);
        $grid.hidden = false;
      } catch (e) {
        showError(e);
      }
    }

    function renderTeamCard(team) {
      const card = document.createElement('section');
      card.className = 'card';

      // 헤더 (사이즈/메타 표시는 제거 요청)
      const head = document.createElement('header');
      const h2 = document.createElement('h2');
      h2.textContent = team.title || `팀 ${team.id}`;
      head.appendChild(h2);
      card.appendChild(head);

      // 표
      const wrap = document.createElement('div');
      wrap.className = 'table-wrap';

      const table = document.createElement('table');

      // 병합 배치용 가상 그리드
      const grid = Array.from({ length: team.rows }, () => Array(team.cols).fill(null));
      for (const cell of team.cells) {
        const r0 = cell.r - 1, c0 = cell.c - 1;
        grid[r0][c0] = cell;
        const rs = cell.rowspan || 1, cs = cell.colspan || 1;
        for (let r = r0; r < r0 + rs; r++) {
          for (let c = c0; c < c0 + cs; c++) {
            if (r === r0 && c === c0) continue;
            grid[r][c] = 'skip';
          }
        }
      }

      // 테이블 렌더
      for (let r = 0; r < team.rows; r++) {
        const tr = document.createElement('tr');
        for (let c = 0; c < team.cols; c++) {
          const cell = grid[r][c];
          if (cell === 'skip') continue;

          const td = document.createElement('td');

          if (cell && cell.text != null) {
            if (cell.rowspan && cell.rowspan > 1) td.rowSpan = cell.rowspan;
            if (cell.colspan && cell.colspan > 1) td.colSpan = cell.colspan;

            // 색상 반영 (시트 원본)
            if (cell.bg)    td.style.backgroundColor = cell.bg;
            if (cell.color) td.style.color = cell.color;

            td.textContent = cell.text; // 표시값 그대로
          } else {
            td.textContent = '';
          }

          tr.appendChild(td);
        }
        table.appendChild(tr);
      }

      wrap.appendChild(table);
      card.appendChild(wrap);

      return card;
    }

    /* ───────── 유틸 ───────── */
    async function fetchJson(url) {
      const r = await fetch(url, { cache:'no-store' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    function setStatus(msg, on=true) {
      if (on && msg) {
        $status.textContent = msg;
        $status.hidden = false;
      } else {
        $status.hidden = true;
        $status.textContent = '';
      }
    }

    function showError(e) {
      console.error(e);
      setStatus(`오류: ${e && e.message ? e.message : e}`, true);
      $grid.hidden = true;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => (
        {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]
      ));
    }
  </script>
</body>
</html>
