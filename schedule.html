<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>월간 스케줄</title>
<style>
  /* 문서 스크롤 제거, 내부 컨테이너만 스크롤 */
  html, body { height:100%; margin:0; overflow:hidden; font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; color:#222; }

  /* 공통 네비(월별 대상처 리스트와 동일 톤) */
  .nav{
    background:#2c3e50; color:#fff;
    padding:10px;
    display:flex; justify-content:flex-end; gap:10px;
    position:sticky; top:0; z-index:1000;
  }
  .nav button{
    background:#fff; color:#000; border:none; border-radius:4px;
    padding:6px 12px; cursor:pointer;
  }

  /* 상단 바(월별 대상처 리스트의 #top-bar 스타일) */
  #top-bar{
    background:#f0f0f0; border-bottom:1px solid #ddd;
    padding:8px 15px;
    display:flex; align-items:center; gap:10px;
    position:sticky; top:0; z-index:900; /* JS에서 top 값 보정 */
  }
  #top-bar h1{ font-size:18px; margin:0; }
  #top-bar select, #top-bar button{
    padding:5px 10px; font-size:14px;
    border:1px solid #dcdcdc; border-radius:8px; background:#fff;
  }
  #status{ color:#666; font-size:13px; margin-left:4px; }

  /* 이 영역만 스크롤 */
  .page{
    overflow:auto;
    padding:12px 14px 16px;
    box-sizing:border-box;
    height:calc(100vh - 96px); /* 실제 값은 JS가 재계산 */
  }

  /* 2열 전폭 그리드 */
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

  /* 카드/표 */
  .card{
    border:1px solid #e5e7eb;
    border-radius:12px;
    overflow:hidden;
    background:#fff;
    box-shadow:0 1px 4px rgba(0,0,0,.04);
  }
  /* 팀 라벨(강조) */
  .teambar{
    background:#e9eef5;
    border-bottom:1px solid #dbe2ea;
    color:#1f2937;
    font-size:12px;
    font-weight:700;
    letter-spacing:.2px;
    padding:8px 12px;
  }

  .table-wrap{ overflow:auto; }
  table{ border-collapse:collapse; width:100%; table-layout:fixed; }
  td{
    border:1px solid #e6e6e6;
    padding:3px 6px;
    vertical-align:top;
    word-break:break-word;
    font-size:12px;
    line-height:1.15;
  }
</style>
</head>
<body>
  <!-- 공통 네비 -->
  <div class="nav" id="nav">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='monthly.html'">월별 대상처 리스트</button>
    <button onclick="location.href='map.html'">지도 보기</button>
    <button onclick="location.href='schedule.html'">스케줄</button>
  </div>

  <!-- 상단 바 -->
  <div id="top-bar">
    <h1>월간 스케줄</h1>
    <label for="sheetSelect"><strong>월 선택:</strong></label>
    <select id="sheetSelect"></select>
    <button id="refreshBtn">새로고침</button>
    <span id="status"></span>
  </div>

  <!-- 내부 스크롤 영역 -->
  <div class="page" id="page">
    <div id="grid" class="grid"></div>
  </div>

<script>
  /* ===== 레이아웃: 바깥 스크롤 제거하고 내부 .page만 스크롤 ===== */
  function relayout(){
    const nav  = document.getElementById('nav');
    const top  = document.getElementById('top-bar');
    const page = document.getElementById('page');
    const navH = nav ? nav.offsetHeight : 0;
    const topH = top ? top.offsetHeight : 0;

    top.style.top = navH + 'px';
    page.style.height = `calc(100vh - ${navH + topH}px)`;
  }
  window.addEventListener('load', relayout);
  window.addEventListener('resize', relayout);

  /* ===== 데이터 ===== */
  const api = (qs) => `/api/schedule${qs ? ('?' + qs) : ''}`;

  const $select  = document.getElementById('sheetSelect');
  const $refresh = document.getElementById('refreshBtn');
  const $grid    = document.getElementById('grid');
  const $status  = document.getElementById('status');

  const now = new Date();
  const initMonth = (now.getMonth() + 1) + '월';

  init().catch(showError);

  async function init(){
    const sheets = await fetchJson(api('mode=sheets')).then(r => r.sheets || []);
    $select.innerHTML = sheets.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join('');
    $select.value = sheets.includes(initMonth) ? initMonth : (sheets[0] || '1월');

    await render($select.value);

    $select.addEventListener('change', () => render($select.value));
    $refresh.addEventListener('click',  () => render($select.value));
  }

  async function render(sheetName){
    try{
      setLoading(`${sheetName} 불러오는 중…`);
      const data = await fetchJson(api(new URLSearchParams({ mode:'month', sheet: sheetName }).toString()));
      if(!data.ok) throw new Error(data.error || 'API 오류');

      $grid.innerHTML = '';
      const year = data.year || (new Date()).getFullYear(); // API에 year가 없으면 올해로 가정
      for(const team of data.teams){
        $grid.appendChild(renderTeam(team, { sheetName, year }));
      }
      setLoading('');
      relayout();
    }catch(e){
      showError(e);
    }
  }

  /* ===== 일자 자동 표기 보조 함수 ===== */
  function parseMonth(sheetName){
    const m = parseInt(String(sheetName).replace(/\D+/g,''),10);
    return isNaN(m) ? (new Date().getMonth()+1) : m;
  }
  function daysInMonth(year, month){ return new Date(year, month, 0).getDate(); }
  function dowKR(y,m,d){ return ['일','월','화','수','목','금','토'][new Date(y, m-1, d).getDay()]; }
  function isGrayColor(c){
    if(!c) return false;
    c = c.toLowerCase();
    // 회색 계열 대략 탐지 (시트 변환 색이 조금 달라도 잡히게 폭넓게)
    return ['#eee','#e6e6e6','#e5e7eb','#f0f0f0','#dddddd','#dcdcdc','#ececec','#efefef','#e9eef5'].some(g => c.startsWith(g));
  }
  function hasAnyText(cell){
    if(!cell) return false;
    if(cell.html && cell.html.trim() !== '') return true;
    if((cell.text ?? '').toString().trim() !== '') return true;
    return false;
  }

  function renderTeam(team, { sheetName, year } = {}){
    const card = document.createElement('section');
    card.className = 'card';

    const bar = document.createElement('div');
    bar.className = 'teambar';
    bar.textContent = `${team.id}팀`;
    card.appendChild(bar);

    const wrap  = document.createElement('div');
    wrap.className = 'table-wrap';
    const table = document.createElement('table');

    // 팀 내 날짜 카운터 준비
    const month = parseMonth(sheetName);
    const lastDay = daysInMonth(year, month);
    let dayCounter = 1;

    // 그리드 구성
    const grid = Array.from({length: team.rows}, () => Array(team.cols).fill(null));
    for(const cell of team.cells){
      const r0 = cell.r - 1, c0 = cell.c - 1;
      grid[r0][c0] = cell;
      const rs = cell.rowspan || 1, cs = cell.colspan || 1;
      for(let r=r0; r<r0+rs; r++){
        for(let c=c0; c<c0+cs; c++){
          if(r===r0 && c===c0) continue;
          grid[r][c] = 'skip';
        }
      }
    }

    // 표 렌더링
    for(let r=0; r<team.rows; r++){
      const tr = document.createElement('tr');
      for(let c=0; c<team.cols; c++){
        const cell = grid[r][c];
        if(cell === 'skip') continue;
        const td = document.createElement('td');

        if(cell){
          if(cell.rowspan > 1) td.rowSpan = cell.rowspan;
          if(cell.colspan > 1) td.colSpan = cell.colspan;
          if(cell.bg) td.style.backgroundColor = cell.bg;

          // ① 원 데이터가 HTML을 주면 그대로
          if(cell.html && cell.html.trim() !== ''){
            td.innerHTML = cell.html;
          }else{
            if(cell.fc) td.style.color = cell.fc;
            td.textContent = (cell.text ?? '').toString();
          }

          // ② "회색 + 전폭 병합 + 내용 없음"이면 일자 자동 표기
          const isFullWidth = (cell.colspan || 1) >= team.cols;
          const empty = !hasAnyText(cell);
          if(empty && isFullWidth && isGrayColor(cell.bg)){
            if(dayCounter <= lastDay){
              td.textContent = `${dayCounter}일(${dowKR(year, month, dayCounter)})`;
              td.style.fontWeight = '700';
            }
            dayCounter++; // 다음 회색줄은 다음 날
          }
        }else{
          td.textContent = '';
        }
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }

    wrap.appendChild(table);
    card.appendChild(wrap);
    return card;
  }

  /* ===== 유틸 ===== */
  async function fetchJson(url){
    const r = await fetch(url, { cache:'no-store' });
    if(!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }
  function setLoading(msg){ $status.textContent = msg || ''; }
  function showError(e){ console.error(e); setLoading(`오류: ${e?.message || e}`); }
  function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
</script>
</body>
</html>
