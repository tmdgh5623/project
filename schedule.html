<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>월간 스케줄</title>
<style>
  /* ===== 기본 레이아웃 ===== */
  html, body { height:100%; margin:0; overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; color:#222; }
  .nav{ background:#2c3e50; color:#fff; padding:10px; display:flex; justify-content:flex-end; gap:10px; position:sticky; top:0; z-index:1000; }
  .nav button{ background:#fff; color:#000; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; }

  #top-bar{ background:#f0f0f0; border-bottom:1px solid #ddd; padding:8px 15px; display:flex; align-items:center; gap:10px; position:sticky; top:0; z-index:900; }
  #top-bar h1{ font-size:18px; margin:0; }
  #top-bar select, #top-bar button{ padding:5px 10px; font-size:14px; border:1px solid #dcdcdc; border-radius:8px; background:#fff; }
  #status{ color:#666; font-size:13px; margin-left:4px; }

  .page{ overflow:auto; padding:12px 14px 16px; box-sizing:border-box; height:calc(100vh - 96px); }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
  @media (max-width:980px){ .grid{ grid-template-columns:1fr; } }

  .card{ border:1px solid #e5e7eb; border-radius:12px; overflow:visible; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04); }
  .teambar{ background:#e9eef5; border-bottom:1px solid #dbe2ea; color:#1f2937; font-size:12px; font-weight:700; letter-spacing:.2px; padding:8px 12px; }

  /* ===== 균일 주간 레이아웃 변수 ===== */
  :root{
    --week-h: 150px;    /* 스케줄(한 주) 높이 */
    --date-h: 20px;     /* 날짜 숫자줄 높이 */
    --band-h: 26px;     /* 빨간 밴드 한 줄 높이 */
  }

  .table-wrap{ padding:10px; }

  /* 요일 바 */
  .dow-bar{
    display:grid; grid-template-columns:repeat(7,1fr);
    border:1px solid #e6e6e6; border-bottom:none; border-radius:8px 8px 0 0;
    background:#efe3a6; font-weight:700; font-size:12px; color:#111; overflow:hidden;
  }
  .dow-bar div{ padding:6px 8px; text-align:center; border-right:1px solid #e6e6e6; }
  .dow-bar div:last-child{ border-right:none; }
  .dow-bar .sun{ color:#d11; }
  .dow-bar .sat{ color:#1d4ed8; }

  /* 주 컨테이너 */
  .week{ border:1px solid #e6e6e6; border-top:none; }
  .week:last-child{ border-radius:0 0 8px 8px; overflow:hidden; }

  /* 스케줄 그리드 */
  .week-grid{
    position:relative;
    display:grid;
    grid-template-columns:repeat(7,1fr);
    grid-template-rows: var(--date-h) repeat(var(--lanes), 1fr);
    height: var(--week-h);
    background:#fff;
  }
  /* 세로선 + 가로 레인 보조선 */
  .week-grid::before{
    content:""; position:absolute; inset:0;
    background:
      repeating-linear-gradient(to right,
        transparent, transparent calc((100%/7) - 1px),
        #e6e6e6 calc((100%/7) - 1px), #e6e6e6 calc(100%/7)),
      repeating-linear-gradient(to bottom,
        transparent var(--date-h), transparent calc(var(--date-h) + ((100% - var(--date-h)) / var(--lanes) - 1px)),
        #f5f5f5 calc(var(--date-h) + ((100% - var(--date-h)) / var(--lanes) - 1px)),
        #f5f5f5 calc(var(--date-h) + ((100% - var(--date-h)) / var(--lanes))));
    pointer-events:none;
  }

  /* 날짜 숫자 */
  .day-num{ grid-row:1; border-bottom:1px solid #e6e6e6; padding:2px 4px; font-size:11px; text-align:right; line-height:1; }
  .day-num.sun{ color:#d11; font-weight:700; }
  .day-num.sat{ color:#1d4ed8; font-weight:700; }
  .day-num.dim{ color:#9ca3af; font-weight:600; }

  /* 이벤트 카드 */
  .ev{ position:relative; margin:2px 3px; border:1px solid rgba(0,0,0,.15); border-radius:4px; overflow:hidden; }
  .ev .cell{ padding:3px 5px; font-size:12px; line-height:1.15; overflow:hidden; display:block; }

  /* 밴드(빨간 줄) */
  .bands{ border-top:1px dashed #e6e6e6; background:#fff; }
  .band-row{ position:relative; display:grid; grid-template-columns:repeat(7,1fr); height:var(--band-h); }
  .band-row::before{ /* 밴드 줄도 세로선 고정 */
    content:""; position:absolute; inset:0; pointer-events:none;
    background:repeating-linear-gradient(to right,
      transparent, transparent calc((100%/7) - 1px),
      #f0f0f0 calc((100%/7) - 1px), #f0f0f0 calc(100%/7));
  }
  .band-cell{ padding:3px 6px; font-size:12px; line-height:1.15; overflow:hidden; border-bottom:1px solid #f0f0f0; }
</style>
</head>
<body>
  <div class="nav" id="nav">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='monthly.html'">월별 대상처 리스트</button>
    <button onclick="location.href='map.html'">지도 보기</button>
    <button onclick="location.href='schedule.html'">스케줄</button>
  </div>

  <div id="top-bar">
    <h1>월간 스케줄</h1>
    <label for="sheetSelect"><strong>월 선택:</strong></label>
    <select id="sheetSelect"></select>
    <button id="refreshBtn">새로고침</button>
    <span id="status"></span>
  </div>

  <div class="page" id="page">
    <div id="grid" class="grid"></div>
  </div>

<script>
  /* ===== 옵션 ===== */
  const MIN_FONT_PX = 9;
  const MAX_FONT_PX = 12;

  /* ===== 레이아웃 ===== */
  function relayout(){
    const nav  = document.getElementById('nav');
    const top  = document.getElementById('top-bar');
    const page = document.getElementById('page');
    const navH = nav ? nav.offsetHeight : 0;
    const topH = top ? top.offsetHeight : 0;
    top.style.top = navH + 'px';
    page.style.height = `calc(100vh - ${navH + topH}px)`;
  }
  window.addEventListener('load', relayout);
  window.addEventListener('resize', () => {
    relayout();
    document.querySelectorAll('.ev .cell, .band-cell').forEach(el => shrinkToFit(el, MIN_FONT_PX));
  });

  /* ===== 데이터 ===== */
  const api = (qs) => `/api/schedule${qs ? ('?' + qs) : ''}`;
  const $select  = document.getElementById('sheetSelect');
  const $refresh = document.getElementById('refreshBtn');
  const $grid    = document.getElementById('grid');
  const $status  = document.getElementById('status');

  const now = new Date();
  const initMonth = (now.getMonth() + 1) + '월';
  let renderAborter = null;
  let changeTimer = null;

  init().catch(showError);

  async function init(){
    // 시트 목록(5분 캐시)
    let sheets = null;
    try{
      const cached = JSON.parse(sessionStorage.getItem('sheets:v1') || 'null');
      if (cached && Date.now() - cached.t < 5*60*1000) sheets = cached.list;
    }catch(_){}
    if (!sheets) {
      const j = await fetchJsonRetry(api('mode=sheets'));
      sheets = j.sheets || [];
      sessionStorage.setItem('sheets:v1', JSON.stringify({ t: Date.now(), list: sheets }));
    }

    $select.innerHTML = sheets.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join('');
    $select.value = sheets.includes(initMonth) ? initMonth : (sheets[0] || '1월');

    await render($select.value);

    $select.addEventListener('change', () => {
      clearTimeout(changeTimer);
      changeTimer = setTimeout(() => render($select.value), 250);
    });
    $refresh.addEventListener('click', () => render($select.value));
  }

  async function render(sheetName){
    if (renderAborter) renderAborter.abort();
    renderAborter = new AbortController();
    try{
      setLoading(`${sheetName} 불러오는 중…`);
      const data = await fetchJsonRetry(
        api(new URLSearchParams({ mode:'month', sheet: sheetName }).toString()),
        { signal: renderAborter.signal }
      );
      if(!data.ok) throw new Error(data.error || 'API 오류');

      $grid.innerHTML = '';
      const year = data.year || (new Date()).getFullYear();
      for(const team of data.teams){
        $grid.appendChild(renderTeamUniform(team, { sheetName, year }));
      }
      setLoading('');
      relayout();

      document.querySelectorAll('.ev .cell, .band-cell').forEach(el => shrinkToFit(el, MIN_FONT_PX));
    }catch(e){
      if (e.name === 'AbortError') return;
      showError(e);
    }
  }

  /* ===== 네트워크 유틸 ===== */
  async function fetchJsonRetry(url, { retries = 5, signal } = {}){
    let attempt = 0;
    while (true){
      try{
        const r = await fetch(url, { cache:'no-store', signal });
        if (r.ok) return r.json();
        if (r.status === 429 || r.status === 503){
          attempt++;
          if (attempt > retries) throw new Error(`HTTP ${r.status}`);
          const wait = Math.min(30000, 500 * Math.pow(2, attempt-1) + Math.random()*500);
          setLoading(`요청 한도(HTTP ${r.status})… ${Math.round(wait/1000)}초 후 재시도`);
          await new Promise(res => setTimeout(res, wait));
          continue;
        }
        throw new Error(`HTTP ${r.status}`);
      }catch(e){
        if (e.name === 'AbortError') throw e;
        attempt++;
        if (attempt > retries) throw e;
        const wait = Math.min(30000, 500 * Math.pow(2, attempt-1) + Math.random()*500);
        setLoading(`네트워크 재시도 중… ${Math.round(wait/1000)}초`);
        await new Promise(res => setTimeout(res, wait));
      }
    }
  }

  /* ===== 공통 유틸 ===== */
  function parseMonth(sheetName){
    const m = parseInt(String(sheetName).replace(/\D+/g,''),10);
    return isNaN(m) ? (new Date().getMonth()+1) : m;
  }
  function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); }
  function dowKR(y,m,d){ return ['일','월','화','수','목','금','토'][new Date(y, m-1, d).getDay()]; }

  function isGrayColor(c){
    if(!c) return false;
    c = String(c).trim().toLowerCase();
    const common = ['#fff','#ffffff','#eee','#e6e6e6','#e5e7eb','#f0f0f0','#dddddd','#dcdcdc','#ececec','#efefef','#e9eef5','#f3f4f6','#e0e0e0','#cccccc','white','transparent'];
    if(common.some(x => c.startsWith(x))) return true;
    const m = c.match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
    if(m){
      const r=+m[1], g=+m[2], b=+m[3];
      const avg = (r+g+b)/3, maxDiff = Math.max(Math.abs(r-avg), Math.abs(g-avg), Math.abs(b-avg));
      return avg >= 235 || (avg >= 200 && maxDiff <= 10);
    }
    return false;
  }

  // 빨간(밴드) 색 판별
  function isRedishColor(c){
    if(!c) return false;
    c = String(c).trim().toLowerCase();
    const quick = ['#f4cccc','#f8d7da','#ffe5e5','#ffd6d6','#fdd','salmon','lightcoral','mistyrose','#e7b5b5','#dca7a7'];
    if (quick.includes(c)) return true;
    const hx = c.match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
    if (hx){
      let h = hx[1]; if (h.length===3) h = h.split('').map(x=>x+x).join('');
      const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
      return (r - Math.max(g,b) >= 30) && r >= 140;
    }
    const rgb = c.match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
    if (rgb){
      const r=+rgb[1], g=+rgb[2], b=+rgb[3];
      return (r - Math.max(g,b) >= 30) && r >= 140;
    }
    return false;
  }

  function visibleText(cell){
    if(cell?.html){
      return String(cell.html)
        .replace(/<br\s*\/?>/gi,' ')
        .replace(/&nbsp;/gi,' ')
        .replace(/<[^>]*>/g,'')
        .trim();
    }
    return String(cell?.text ?? '').trim();
  }

  // "날짜 숫자만 있는 줄" 감지
  function isWeekNumberRow(rowCells, cols){
    let countDigits = 0, countCells = 0;
    for(let c=0; c<cols; c++){
      const cell = rowCells[c]; if(cell === 'skip') continue; countCells++;
      const t = visibleText(cell); if(/^\d{1,2}$/.test(t)) countDigits++;
    }
    return countDigits >= Math.max(5, Math.floor(cols*0.6));
  }

  /* ===== 팀 렌더러: rowspan 무시 + 균일 격자 + 자동 레인 + 밴드 분리 ===== */
  function renderTeamUniform(team, { sheetName, year } = {}){
    const card = document.createElement('section'); card.className = 'card';
    const bar  = document.createElement('div'); bar.className = 'teambar'; bar.textContent = `${team.id}팀`; card.appendChild(bar);
    const wrap = document.createElement('div'); wrap.className = 'table-wrap'; card.appendChild(wrap);

    // 요일 바
    const dow = ['일요일(Sun)','월요일(Mon)','화요일(Tue)','수요일(Wed)','목요일(Thu)','금요일(Fri)','토요일(Sat)'];
    const dowBar = document.createElement('div'); dowBar.className = 'dow-bar';
    dow.forEach((name,i) => {
      const d = document.createElement('div'); d.textContent = name;
      if (i===0) d.classList.add('sun'); if (i===6) d.classList.add('sat');
      dowBar.appendChild(d);
    });
    wrap.appendChild(dowBar);

    const month    = parseMonth(sheetName);
    const lastDay  = daysInMonth(year, month);
    const firstDow = new Date(year, month-1, 1).getDay();

    /* 1) 병합 반영 그리드 생성 (anchor만 사용)
       - rowspan은 무시하려고 anchor만 읽고, 세로 확장은 고려하지 않음
    */
    const grid = Array.from({length: team.rows}, () => Array(team.cols).fill(null));
    for (const cell of team.cells){
      const r0 = cell.r - 1, c0 = cell.c - 1;
      grid[r0][c0] = cell;
      const rs = cell.rowspan || 1, cs = cell.colspan || 1;
      for (let r=r0; r<r0+rs; r++){
        for (let c=c0; c<c0+cs; c++){
          if (r===r0 && c===c0) continue; grid[r][c] = 'skip';
        }
      }
    }

    /* 2) 주(week) 경계 계산 */
    const weekStartIdx = [];
    for (let r=0; r<team.rows; r++) if (isWeekNumberRow(grid[r], team.cols)) weekStartIdx.push(r);
    const weeks = weekStartIdx.map((start, i) => {
      const end = (i+1 < weekStartIdx.length) ? weekStartIdx[i+1] : team.rows;
      return { r0:start, r1:end };
    });

    /* 3) 주별 렌더링 */
    weeks.forEach((wk, wIdx) => {
      const events = [];
      const bandRows = []; // 빨간 줄 모음(원본 순서 유지)

      for (let r = wk.r0+1; r < wk.r1; r++){
        // 이 줄이 "밴드"인지 판단: 텍스트 있는 anchor들의 bg가 전부 빨강 계열이면 밴드
        let hasText=false, redOnly=true;
        for(let c=0;c<team.cols;c++){
          const cell = grid[r][c]; if(!cell || cell==='skip') continue;
          const t = visibleText(cell); if(!t) continue;
          hasText=true; if(!isRedishColor(cell.bg)) redOnly=false;
        }

        if (hasText && redOnly){
          const br = { cells:[] };
          for(let c=0;c<team.cols;c++){
            const cell = grid[r][c]; if(!cell || cell==='skip') continue;
            const t = visibleText(cell); if(!t) continue;
            const span = Math.max(1, cell.colspan || 1);
            const startCol = c + 1;
            br.cells.push({ startCol, span: Math.min(span, team.cols - c), text: t, bg: cell.bg, fc: cell.fc });
          }
          bandRows.push(br);
        }else{
          for(let c=0;c<team.cols;c++){
            const cell = grid[r][c]; if(!cell || cell==='skip') continue;
            const t = visibleText(cell); if(!t) continue;
            if (isRedishColor(cell.bg)) continue; // 밴드는 위에서 처리
            const span = Math.max(1, cell.colspan || 1);
            const startCol = c + 1;
            events.push({ startCol, span: Math.min(span, team.cols - c), text: t, bg: cell.bg, fc: cell.fc });
          }
        }
      }

      // 자동 레인 배치(겹치지 않게)
      events.sort((a,b)=> a.startCol - b.startCol || b.span - a.span);
      const lanes = [];
      for(const ev of events){
        let placed = false;
        for (let i=0; i<lanes.length; i++){
          if (ev.startCol > (lanes[i].endCol || 0)) { lanes[i].endCol = ev.startCol + ev.span - 1; ev.lane = i; placed = true; break; }
        }
        if (!placed){ ev.lane = lanes.length; lanes.push({ endCol: ev.startCol + ev.span - 1 }); }
      }

      // 주 컨테이너
      const weekEl = document.createElement('section'); weekEl.className = 'week';

      // 스케줄 그리드
      const gridEl = document.createElement('div');
      gridEl.className = 'week-grid';
      gridEl.style.setProperty('--lanes', Math.max(1, lanes.length || 1));

      // 날짜 숫자 7칸
      for (let col=0; col<7; col++){
        const pos     = (wIdx * 7) + col - firstDow + 1;
        const inMonth = (pos >= 1 && pos <= lastDay);
        let dow;
        if (inMonth) dow = new Date(year, month-1, pos).getDay();
        else if (pos < 1) { const prevLast = daysInMonth(year, month-1); dow = new Date(year, month-2, prevLast + pos).getDay(); }
        else { dow = new Date(year, month, pos - lastDay).getDay(); }

        const d = document.createElement('div');
        d.className = 'day-num';
        if (!inMonth) d.classList.add('dim');
        if (dow === 0) d.classList.add('sun');
        if (dow === 6) d.classList.add('sat');
        d.style.gridColumn = (col+1);
        d.textContent = `${pos}`;
        gridEl.appendChild(d);
      }

      // 이벤트 카드 추가(색/글자색은 원본 그대로)
      for(const ev of events){
        const e = document.createElement('div'); e.className = 'ev';
        e.style.gridColumn = `${ev.startCol} / ${ev.startCol + ev.span}`;
        e.style.gridRow    = `${(ev.lane||0)+2}`;
        if (ev.bg && !isGrayColor(ev.bg)) e.style.background = ev.bg;
        if (ev.fc) e.style.color = ev.fc;
        const inner = document.createElement('div'); inner.className = 'cell'; inner.textContent = ev.text;
        e.appendChild(inner); gridEl.appendChild(e);
      }

      weekEl.appendChild(gridEl);

      // 밴드 줄(스케줄 아래, 고정높이)
      if (bandRows.length){
        const bands = document.createElement('div'); bands.className = 'bands';
        for (const br of bandRows){
          const row = document.createElement('div'); row.className = 'band-row';
          br.cells.forEach(c=>{
            const cell = document.createElement('div'); cell.className = 'band-cell';
            if (c.bg) cell.style.background = c.bg;
            if (c.fc) cell.style.color = c.fc;
            cell.textContent = c.text;
            cell.style.gridColumn = `${c.startCol} / ${c.startCol + c.span}`;
            row.appendChild(cell);
          });
          bands.appendChild(row);
        }
        weekEl.appendChild(bands);
      }

      wrap.appendChild(weekEl);
    });

    return card;
  }

  /* ===== 텍스트 축소 ===== */
  function shrinkToFit(el, minPx){
    if (!el) return; if (!el.textContent.trim() && el.children.length === 0) return;
    let fs = parseFloat(getComputedStyle(el).fontSize) || MAX_FONT_PX;
    for (let i=0; i<12; i++){
      const fitsH = el.scrollHeight <= el.clientHeight;
      const fitsW = el.scrollWidth  <= el.clientWidth;
      if (fitsH && fitsW) break;
      const hRatio = el.clientHeight / Math.max(el.scrollHeight, 1);
      const wRatio = el.clientWidth  / Math.max(el.scrollWidth, 1);
      const ratio  = Math.max(0.5, Math.min(hRatio, wRatio)) * 0.98;
      const next = Math.max(minPx, Math.floor(fs * ratio));
      if (next >= fs) break;
      fs = next;
      el.style.fontSize = fs + 'px';
      el.style.lineHeight = (0.95 + (fs - minPx) * 0.02).toFixed(2);
      if (fs <= minPx) break;
    }
  }

  /* ===== 공통 ===== */
  function setLoading(msg){ $status.textContent = msg || ''; }
  function showError(e){ console.error(e); setLoading(`오류: ${e?.message || e}`); }
  function esc(s){ const map = {"&":"&amp;","<":"&lt;","<": "&lt;", ">":"&gt;","\"":"&quot;","'":"&#39;"}; return String(s).replace(/[&<>"']/g, ch => map[ch]); }
</script>
</body>
</html>
