<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>월간 스케줄</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; color:#222; background:#fff; }

    .topnav{
      background:#2c3e50; color:#fff; padding:10px;
      display:flex; justify-content:flex-end; gap:10px;
    }
    .topnav button{
      background:#fff; color:#000; border:none; border-radius:4px;
      padding:6px 12px; cursor:pointer;
    }

    #top-bar{
      background:#f0f0f0; padding:8px 15px; display:flex; align-items:center; gap:10px;
      border-bottom:1px solid #ccc; position:sticky; top:0; z-index:10;
    }
    h1{ font-size:18px; margin:0; }
    select{ padding:5px; font-size:14px; }
    .basic{ padding:6px 10px; font-size:14px; border:1px solid #ccc; background:#fff; border-radius:4px; cursor:pointer; }

    /* 메타 텍스트는 요청대로 숨김 */
    #meta{ display:none; }

    .wrap{ padding:14px 15px 28px; }

    .grid{
      display:grid; grid-template-columns:1fr 1fr; grid-template-rows:auto auto; gap:12px;
    }
    .card{
      border:1px solid #ccc; border-radius:0; background:#fff; overflow:hidden;
    }
    .card header{
      display:flex; justify-content:space-between; align-items:center;
      background:#f2f2f2; border-bottom:1px solid #ccc; padding:8px 10px;
    }
    .card header h2{ margin:0; font-size:16px; font-weight:600; }

    .table-wrap{ overflow:auto; }
    table{ border-collapse:collapse; width:100%; table-layout:fixed; }
    td{
      border:1px solid #ccc; background:#fff;
      padding:4px 6px; font-size:12px; line-height:1.2; vertical-align:top; word-break:break-word;
    }

    @media (max-width:980px){
      .grid{ grid-template-columns:1fr; grid-template-rows:auto auto auto auto; }
    }
  </style>
</head>
<body>
  <!-- 상단 네비 -->
  <div class="topnav">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='monthly.html'">월별 대상처 리스트</button>
    <button onclick="location.href='map.html'">지도 보기</button>
    <button onclick="location.href='schedule.html'">스케줄</button>
  </div>

  <!-- 상단 회색 바 -->
  <div id="top-bar">
    <h1>월간 스케줄</h1>
    <label for="sheetSelect"><strong>월 선택:</strong></label>
    <select id="sheetSelect"></select>
    <button id="refreshBtn" class="basic">새로고침</button>
    <span id="meta"></span>
  </div>

  <div class="wrap">
    <div id="grid" class="grid"></div>
  </div>

  <script>
    const api = (qs) => `/api/schedule${qs ? ('?' + qs) : ''}`;

    const qs = new URLSearchParams(location.search);
    const initialSheet = qs.get('sheet') || null;

    const $select  = document.getElementById('sheetSelect');
    const $refresh = document.getElementById('refreshBtn');
    const $grid    = document.getElementById('grid');
    const $meta    = document.getElementById('meta');

    // 시트별 캐시
    const cache = new Map();
    // 요청 취소용
    let currentController = null;

    init().catch(()=>{});

    async function init(){
      const sheets = await fetchJson(api('mode=sheets')).then(r => r.sheets || []);
      $select.innerHTML = sheets.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');

      const use = initialSheet && sheets.includes(initialSheet) ? initialSheet : guessCurrentSheet(sheets);
      $select.value = use;

      renderMonth(use);

      $select.addEventListener('change', () => renderMonth($select.value));
      $refresh.addEventListener('click',  () => renderMonth($select.value));
    }

    function guessCurrentSheet(sheets){
      if (!sheets.length) return '1월';
      const nowSeoul = new Date(new Date().toLocaleString('en-US', { timeZone:'Asia/Seoul' }));
      const m = nowSeoul.getMonth() + 1;
      const yy = String(nowSeoul.getFullYear()).slice(2);
      const exact = [`${m}월`, `${yy}년${m}월`];
      for (const cand of exact){
        const hit = sheets.find(s => s === cand);
        if (hit) return hit;
      }
      for (const cand of exact){
        const hit = sheets.find(s => s.includes(cand));
        if (hit) return hit;
      }
      return sheets.find(s => s.includes(`${m}월`)) || sheets[0];
    }

    async function renderMonth(sheetName){
      if (currentController) currentController.abort();
      currentController = new AbortController();

      const cached = cache.get(sheetName);
      if (cached) paint(cached);

      try{
        const data = await fetchJson(
          api(new URLSearchParams({ mode:'month', sheet:sheetName }).toString()),
          currentController.signal
        );
        if (!data.ok) throw new Error(data.error || 'API 오류');
        cache.set(sheetName, data);
        paint(data);
      }catch(e){
        if (e.name === 'AbortError') return;
      }finally{
        currentController = null;
      }
    }

    function paint(data){
      $grid.innerHTML = '';
      for (const team of data.teams){
        $grid.appendChild(renderTeamCard(team));
      }
    }

    // ✅ 팀 카드: 우측의 "열×행" 텍스트 제거 + 오른쪽 완전빈 열 자동 제거
    function renderTeamCard(team){
      const card = document.createElement('section');
      card.className = 'card';

      const head = document.createElement('header');
      const h2   = document.createElement('h2'); h2.textContent = team.title || `팀 ${team.id}`;
      head.append(h2);                     // ← 크기 텍스트는 넣지 않음
      card.appendChild(head);

      const wrap  = document.createElement('div'); wrap.className = 'table-wrap';
      const table = document.createElement('table');

      // ▶ 사용된 마지막 열만 계산해 스페이서(완전 빈 열) 제거
      let lastUsedCol = 0;
      for (const cell of team.cells){
        const end = (cell.c || 1) + ((cell.colspan || 1) - 1);
        if (end > lastUsedCol) lastUsedCol = end;
      }
      const colsToRender = Math.max(1, Math.min(team.cols || 1, lastUsedCol));

      // 병합 셀 배치용 그리드
      const grid = Array.from({length: team.rows}, () => Array(colsToRender).fill(null));

      for (const cell of team.cells){
        const r0 = (cell.r || 1) - 1;
        const c0 = (cell.c || 1) - 1;
        const rs = cell.rowspan || 1;
        const rawCs = cell.colspan || 1;

        // 셀이 오른쪽으로 colsToRender를 넘으면 잘라서 넣기
        const colEnd = Math.min(colsToRender - 1, c0 + rawCs - 1);
        const cs = colEnd - c0 + 1;
        if (cs <= 0) continue; // 전부 잘린 경우

        grid[r0][c0] = { ...cell, colspan: cs };
        for (let r = r0; r < r0 + rs; r++){
          for (let c = c0; c < c0 + cs; c++){
            if (r === r0 && c === c0) continue;
            if (r >= 0 && r < team.rows && c >= 0 && c < colsToRender){
              grid[r][c] = 'skip';
            }
          }
        }
      }

      for (let r=0; r<team.rows; r++){
        const tr = document.createElement('tr');
        for (let c=0; c<colsToRender; c++){
          const cell = grid[r][c];
          if (cell === 'skip') continue;
          const td = document.createElement('td');
          if (cell && cell.text != null){
            if (cell.rowspan && cell.rowspan > 1) td.rowSpan = cell.rowspan;
            if (cell.colspan && cell.colspan > 1) td.colSpan = cell.colspan;
            if (cell.bg) td.style.backgroundColor = cell.bg;
            td.textContent = cell.text;
          }
          tr.appendChild(td);
        }
        table.appendChild(tr);
      }

      wrap.appendChild(table);
      card.appendChild(wrap);
      return card;
    }

    async function fetchJson(url, signal){
      const r = await fetch(url, { cache:'no-store', signal });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return r.json();
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
