<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>월간 스케줄</title>
<style>
  /* ===== 기본 레이아웃 ===== */
  html, body { height:100%; margin:0; overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif; color:#222; }
  .nav{ background:#2c3e50; color:#fff; padding:10px; display:flex; justify-content:flex-end; gap:10px; position:sticky; top:0; z-index:1000; }
  .nav button{ background:#fff; color:#000; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; }

  #top-bar{ background:#f0f0f0; border-bottom:1px solid #ddd; padding:8px 15px; display:flex; align-items:center; gap:10px; position:sticky; top:0; z-index:900; }
  #top-bar h1{ font-size:18px; margin:0; }
  #top-bar select, #top-bar button{ padding:5px 10px; font-size:14px; border:1px solid #dcdcdc; border-radius:8px; background:#fff; }
  #status{ color:#666; font-size:13px; margin-left:4px; }

  /* 페이지(상단바 제외 영역) */
  .page{
    overflow:auto; padding:12px 14px 16px; box-sizing:border-box;
    height:calc(100vh - 96px);
  }

  /* ===== 한 화면에 ‘한 팀’씩(세로 스크롤) ===== */
  .grid{
    display:grid;
    grid-template-columns:1fr;   /* 한 컬럼 */
    grid-auto-rows:100%;         /* 각 카드가 화면 높이 100% */
    gap:14px;
    height:100%;
    scroll-snap-type:y proximity;
  }
  .card{
    border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 1px 4px rgba(0,0,0,.04);
    display:flex; flex-direction:column; height:100%;
    scroll-snap-align:start;
  }
  .teambar{ background:#e9eef5; border-bottom:1px solid #dbe2ea; color:#1f2937; font-size:12px; font-weight:700; letter-spacing:.2px; padding:8px 12px; }

  /* ===== 표 ===== */
  .table-wrap{ flex:1 1 auto; overflow:hidden; }
  table{
    border-collapse:collapse; width:100%; table-layout:fixed; height:100%;

    /* 날짜/요일 줄 높이(동일) */
    --weeknum-h:     10px;             /* 날짜 숫자 줄 높이 */
    --dow-h:         var(--weeknum-h); /* 요일 줄 = 날짜 줄과 동일 */

    --weeknum-font:   8px;
    --weeknum-pad-v:  1px;
    --weeknum-pad-h:  3px;
  }

  /* 요일 줄 (날짜 줄과 동일한 높이/폰트/패딩) */
  tr[data-dowrow="1"]{
    height: var(--dow-h);
    background:#f3f4f6;
  }
  tr[data-dowrow="1"] td{
    font-weight:600;
    text-align:center;
    font-size: var(--weeknum-font);
    padding: var(--weeknum-pad-v) var(--weeknum-pad-h);
    line-height:1;
  }

  /* 날짜(숫자) 줄 */
  tr[data-weekrow="1"]{ height: var(--weeknum-h); }
  tr[data-weekrow="1"] td{
    text-align:center;
    padding: var(--weeknum-pad-v) var(--weeknum-pad-h);
    font-size: var(--weeknum-font);
    line-height:1;
  }

  td{
    border:1px solid #e6e6e6;
    padding:3px 6px;
    vertical-align:top;
    word-break:break-word;
    font-size:12px;
    line-height:1.15;
    overflow:hidden;
    height:100%;
    box-sizing:border-box;
  }

  /* 내용은 칸 밖으로 못 나감 */
  td, td .cell, td .it{
    overflow-wrap:anywhere;
    word-break:break-word;
    white-space:normal;
  }

  /* 내용 래퍼(넘침 감지/축소용) */
  td > .cell{ display:block; height:100%; overflow:hidden; }
  td .it{ display:block; margin-bottom:1px; }

  /* 플레이스홀더(강제 줄 채움) */
  tr.placeholder-sched td{ background:#fff; }
  tr.placeholder-note  td{ background:#e9c7c7; } /* 데이터 없을 때의 기타 줄 배경 */
</style>
</head>
<body>
  <div class="nav" id="nav">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='monthly.html'">월별 대상처 리스트</button>
    <button onclick="location.href='map.html'">지도 보기</button>
    <button onclick="location.href='schedule.html'">스케줄</button>
  </div>

  <div id="top-bar">
    <h1>월간 스케줄</h1>
    <label for="sheetSelect"><strong>월 선택:</strong></label>
    <select id="sheetSelect"></select>
    <button id="refreshBtn">새로고침</button>
    <span id="status"></span>
  </div>

  <div class="page" id="page">
    <div id="grid" class="grid"></div>
  </div>

<script>
  /* ===== 옵션 ===== */
  const MIN_FONT_PX = 9;   // 최소 폰트(px)
  const MAX_FONT_PX = 12;  // 기본 폰트(px)

  // 주 구조: 스케줄 4줄 + 기타(빨간) 1줄
  const SCHEDULE_ROWS_PER_WEEK = 4;
  const NOTE_ROWS_PER_WEEK     = 1;

  // 주간 간격 압축 비율(0.5 = 절반)
  const WEEK_HEIGHT_SCALE = 0.5;

  /* ===== 레이아웃 ===== */
  function relayout(){
    const nav  = document.getElementById('nav');
    const top  = document.getElementById('top-bar');
    const page = document.getElementById('page');
    const navH = nav ? nav.offsetHeight : 0;
    const topH = top ? top.offsetHeight : 0;
    top.style.top = navH + 'px';
    page.style.height = `calc(100vh - ${navH + topH}px)`;
  }
  window.addEventListener('load', relayout);
  window.addEventListener('resize', () => {
    relayout();
    setTimeout(()=> { normalizeWeeksToFixedRows(); unifyWeeksByTypeHeights(); shrinkAllText(); }, 50);
  });

  /* ===== 데이터 ===== */
  const api = (qs) => `/api/schedule${qs ? ('?' + qs) : ''}`;
  const $select  = document.getElementById('sheetSelect');
  const $refresh = document.getElementById('refreshBtn');
  const $grid    = document.getElementById('grid');
  const $status  = document.getElementById('status');

  const now = new Date();
  const initMonth = (now.getMonth() + 1) + '월';
  let renderAborter = null;
  let changeTimer = null;

  init().catch(showError);

  async function init(){
    // 시트 목록(5분 캐시)
    let sheets = null;
    try{
      const cached = JSON.parse(sessionStorage.getItem('sheets:v1') || 'null');
      if (cached && Date.now() - cached.t < 5*60*1000) sheets = cached.list;
    }catch(_){}
    if (!sheets) {
      const j = await fetchJsonRetry(api('mode=sheets'));
      sheets = j.sheets || [];
      sessionStorage.setItem('sheets:v1', JSON.stringify({ t: Date.now(), list: sheets }));
    }

    $select.innerHTML = sheets.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join('');
    $select.value = sheets.includes(initMonth) ? initMonth : (sheets[0] || '1월');

    await render($select.value);

    $select.addEventListener('change', () => {
      clearTimeout(changeTimer);
      changeTimer = setTimeout(() => render($select.value), 250);
    });
    $refresh.addEventListener('click', () => render($select.value));
  }

  async function render(sheetName){
    if (renderAborter) renderAborter.abort();
    renderAborter = new AbortController();
    try{
      setLoading(`${sheetName} 불러오는 중…`);
      const data = await fetchJsonRetry(
        api(new URLSearchParams({ mode:'month', sheet: sheetName }).toString()),
        { signal: renderAborter.signal }
      );
      if(!data.ok) throw new Error(data.error || 'API 오류');

      $grid.innerHTML = '';
      const year = data.year || (new Date()).getFullYear();

      // 팀들을 세로로 한 장씩
      for(const team of data.teams){
        const card = renderTeam(team, { sheetName, year });
        $grid.appendChild(card);
      }

      setLoading('');
      relayout();

      /* 순서: 구조 보정 → 높이 균일화 → 글자 맞춤 */
      await settleLayout();
      normalizeWeeksToFixedRows();   // ✅ 주당 4(스케줄)+1(기타) 강제 & 여분 병합
      await settleLayout();
      unifyWeeksByTypeHeights();     // ✅ 모든 주/줄 높이 균등 (화면 높이에 맞춤)
      await settleLayout();
      resetFonts();
      shrinkAllText();               // ✅ 폰트 축소 + 라인 클램프
      requestAnimationFrame(()=> shrinkAllText()); // 안전 1회 더
    }catch(e){
      if (e.name === 'AbortError') return;
      showError(e);
    }
  }

  /* ===== 프레임/폰트 안정화 유틸 ===== */
  function nextFrame(){ return new Promise(r => requestAnimationFrame(()=>r())); }
  async function settleLayout(){
    await nextFrame(); await nextFrame();
    if (document.fonts?.ready) { try { await document.fonts.ready; } catch {} }
  }

  /* ===== 네트워크 유틸 ===== */
  async function fetchJsonRetry(url, { retries = 5, signal } = {}){
    let attempt = 0;
    while (true){
      try{
        const r = await fetch(url, { cache:'no-store', signal });
        if (r.ok) return r.json();
        if (r.status === 429 || r.status === 503){
          attempt++;
          if (attempt > retries) throw new Error(`HTTP ${r.status}`);
          const wait = Math.min(30000, 500 * Math.pow(2, attempt-1) + Math.random()*500);
          setLoading(`요청 한도(HTTP ${r.status})… ${Math.round(wait/1000)}초 후 재시도`);
          await new Promise(res => setTimeout(res, wait));
          continue;
        }
        throw new Error(`HTTP ${r.status}`);
      }catch(e){
        if (e.name === 'AbortError') throw e;
        attempt++;
        if (attempt > retries) throw e;
        const wait = Math.min(30000, 500 * Math.pow(2, attempt-1) + Math.random()*500);
        setLoading(`네트워크 재시도 중… ${Math.round(wait/1000)}초`);
        await new Promise(res => setTimeout(res, wait));
      }
    }
  }

  /* ===== 렌더 유틸 ===== */
  function parseMonth(sheetName){
    const m = parseInt(String(sheetName).replace(/\D+/g,''),10);
    return isNaN(m) ? (new Date().getMonth()+1) : m;
  }
  function daysInMonth(y, m){ return new Date(y, m, 0).getDate(); }
  function dowKR(y,m,d){ return ['일','월','화','수','목','금','토'][new Date(y, m-1, d).getDay()]; }

  function isReddish(c){
    if(!c) return false;
    c = String(c).trim().toLowerCase();
    if (c.startsWith('#')){
      if (c === '#f00' || c === '#ff0000') return true;
      if (c.length === 7){
        const r = parseInt(c.slice(1,3),16);
        const g = parseInt(c.slice(3,5),16);
        const b = parseInt(c.slice(5,7),16);
        return (r>=200 && r>g && r>b);
      }
    }
    const m = c.match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
    if (m){
      const r=+m[1], g=+m[2], b=+m[3];
      return (r>=200 && r>g && r>b);
    }
    return false;
  }

  function visibleText(cell){
    if(cell?.html){
      return String(cell.html).replace(/<br\s*\/?>/gi,' ')
                              .replace(/&nbsp;/gi,' ')
                              .replace(/<[^>]*>/g,'')
                              .trim();
    }
    return String(cell?.text ?? '').trim();
  }

  /* 요일줄 감지 */
  function isDowHeaderRow(rowCells, cols){
    const KR = ['일','월','화','수','목','금','토'];
    const EN = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let hit = 0, total = 0;
    for (let c=0;c<cols;c++){
      const cell = rowCells[c];
      if (cell==='skip') continue;
      total++;
      const t = visibleText(cell);
      if (KR.some(x=>t.includes(x)) || EN.some(x=>t.includes(x))) hit++;
    }
    return hit >= Math.max(5, Math.floor(cols*0.6));
  }

  /* "작은 날짜 숫자" 줄 감지 */
  function isWeekNumberRow(rowCells, cols){
    let digits = 0, total = 0;
    for(let c=0; c<cols; c++){
      const cell = rowCells[c];
      if (cell === 'skip') continue;
      total++;
      const t = visibleText(cell);
      if(/^\d{1,2}$/.test(t)) digits++;
    }
    return digits >= Math.max(5, Math.floor(cols*0.6));
  }

  /* ===== 팀 카드 렌더 ===== */
  function renderTeam(team, { sheetName, year } = {}){
    const card = document.createElement('section'); card.className = 'card';
    const bar  = document.createElement('div'); bar.className = 'teambar'; bar.textContent = `${team.id}팀`; card.appendChild(bar);

    const wrap  = document.createElement('div'); wrap.className = 'table-wrap';
    const table = document.createElement('table');

    const month    = parseMonth(sheetName);
    const lastDay  = daysInMonth(year, month);
    const firstDow = new Date(year, month-1, 1).getDay();

    let weekIdx = -1;

    // 병합 반영 그리드
    const grid = Array.from({length: team.rows}, () => Array(team.cols).fill(null));
    for (const cell of team.cells){
      const r0 = cell.r - 1, c0 = cell.c - 1;
      grid[r0][c0] = cell;
      const rs = cell.rowspan || 1, cs = cell.colspan || 1;
      for (let r=r0; r<r0+rs; r++){
        for (let c=c0; c<c0+cs; c++){
          if (r===r0 && c===c0) continue;
          grid[r][c] = 'skip';
        }
      }
    }

    for (let r=0; r<team.rows; r++){
      const tr = document.createElement('tr');

      const dowRow = (r === 0 && isDowHeaderRow(grid[r], team.cols));
      if (dowRow) tr.dataset.dowrow = '1';

      const weekNumberRow = isWeekNumberRow(grid[r], team.cols);
      if (weekNumberRow) { weekIdx++; tr.dataset.weekrow = '1'; }

      for (let c=0; c<team.cols; c++){
        const cell = grid[r][c];
        if (cell === 'skip') continue;

        const td = document.createElement('td');

        if (cell){
          if (cell.rowspan > 1) td.rowSpan = cell.rowspan;
          if (cell.colspan > 1) td.colSpan = cell.colspan;
          if (cell.bg) td.style.backgroundColor = cell.bg;

          const textNow = visibleText(cell);

          if (weekNumberRow){
            if (/^\d{1,2}$/.test(textNow)){
              const pos     = (weekIdx * 7) + c - firstDow + 1;
              const inMonth = (pos >= 1 && pos <= lastDay);
              let dow;
              if (inMonth) dow = new Date(year, month-1, pos).getDay();
              else if (pos < 1) { const prevLast = daysInMonth(year, month-1); dow = new Date(year, month-2, prevLast + pos).getDay(); }
              else { dow = new Date(year, month, pos - lastDay).getDay(); }

              td.textContent   = textNow;
              td.style.fontWeight = inMonth ? '700' : '600';
              td.style.color = inMonth ? (dow === 0 ? '#d11' : (dow === 6 ? '#1d4ed8' : '#111827')) : '#9ca3af';
            }else{
              if (cell.html && textNow !== '') td.innerHTML = cell.html;
              else { if (cell.fc) td.style.color = cell.fc; td.textContent = textNow; }
            }
          } else {
            if (cell.html && textNow !== '') td.innerHTML = cell.html;
            else { if (cell.fc) td.style.color = cell.fc; td.textContent = textNow; }
          }

        } else {
          td.textContent = '';
        }

        let box = td.querySelector('.cell');
        if(!box){ box = document.createElement('div'); box.className='cell';
          while (td.firstChild) box.appendChild(td.firstChild);
          td.appendChild(box);
        }
        tr.appendChild(td);
      }
      table.appendChild(tr);
    }

    wrap.appendChild(table);
    card.appendChild(wrap);
    return card;
  }

  /* ===== 구조 보정: 주마다 4(스케줄)+1(기타) 강제 & 여분 병합 ===== */
  function normalizeWeeksToFixedRows(){
    document.querySelectorAll('.table-wrap table').forEach(tbl=>{
      const allRows = () => Array.from(tbl.querySelectorAll('tr'));
      const rows0 = allRows();
      const weekStarts = rows0.map((tr,i)=> tr.dataset.weekrow==='1' ? i : -1).filter(i=>i>=0);
      const cols = Math.max(...rows0.map(r=> r.querySelectorAll('td').length)) || 7;

      const ensureCell = (td)=>{
        let box = td.querySelector('.cell');
        if(!box){
          box = document.createElement('div');
          box.className='cell';
          while(td.firstChild) box.appendChild(td.firstChild);
          td.appendChild(box);
        }
        return box;
      };
      const isNoteRow = (tr)=>{
        const tds = Array.from(tr.querySelectorAll('td'));
        let red=0, span=0;
        tds.forEach(td=>{
          const s = td.colSpan || 1;
          const bg = getComputedStyle(td).backgroundColor || td.style.backgroundColor;
          span += s;
          const m = String(bg).match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
          if (m){ const r=+m[1], g=+m[2], b=+m[3]; if (r>=200 && r>g && r>b) red += s; }
        });
        return span && (red/span) >= 0.5;
      };
      const makeEmptyRow = (className)=>{
        const tr = document.createElement('tr'); if (className) tr.className = className;
        for(let c=0;c<cols;c++){
          const td = document.createElement('td');
          const box = document.createElement('div'); box.className='cell';
          td.appendChild(box); tr.appendChild(td);
        }
        return tr;
      };
      const mergeRowInto = (src, dst)=>{
        const dT = dst.querySelectorAll('td');
        const sT = src.querySelectorAll('td');
        const n  = Math.min(dT.length, sT.length, cols);
        for(let j=0;j<n;j++){
          const dstBox = ensureCell(dT[j]);
          const srcBox = sT[j].querySelector('.cell');
          const html   = srcBox ? srcBox.innerHTML.trim() : sT[j].innerHTML.trim();
          if (html){
            const div = document.createElement('div');
            div.className = 'it';
            div.innerHTML = html;
            dstBox.appendChild(div);
          }
        }
        src.remove();
      };

      weekStarts.forEach((ws, idx)=>{
        const rows = allRows();
        const next = weekStarts[idx+1] ?? rows.length;
        const start = ws + 1;
        const inRange = () => allRows().slice(start, next);

        let body   = inRange();
        let scheds = body.filter(tr => !isNoteRow(tr));
        let notes  = body.filter(tr =>  isNoteRow(tr));

        // 스케줄이 4줄 초과 → 4번째 줄로 병합
        if (scheds.length > SCHEDULE_ROWS_PER_WEEK){
          const keep = scheds.slice(0, SCHEDULE_ROWS_PER_WEEK);
          for(let i=SCHEDULE_ROWS_PER_WEEK; i<scheds.length; i++){
            mergeRowInto(scheds[i], keep[SCHEDULE_ROWS_PER_WEEK-1]);
          }
        }

        // 최신화
        body   = inRange();
        scheds = body.filter(tr => !isNoteRow(tr));
        notes  = body.filter(tr =>  isNoteRow(tr));

        // 스케줄 줄 부족 → 노트 앞에 빈 줄 추가
        for(let need = SCHEDULE_ROWS_PER_WEEK - scheds.length; need > 0; need--){
          const tr = makeEmptyRow('placeholder-sched');
          const anchor = notes[0] || allRows()[next] || null;
          tbl.tBodies[0].insertBefore(tr, anchor);
        }

        // 최신화
        body   = inRange();
        scheds = body.filter(tr => !isNoteRow(tr));
        notes  = body.filter(tr =>  isNoteRow(tr));

        // 노트 줄이 1줄 초과 → 첫 줄로 병합
        if (notes.length > NOTE_ROWS_PER_WEEK){
          const keep = notes[0];
          for(let i=1;i<notes.length;i++) mergeRowInto(notes[i], keep);
        }

        // 최신화
        body   = inRange();
        notes  = body.filter(tr =>  isNoteRow(tr));

        // 노트 줄 없음 → 1줄 추가
        if (notes.length < NOTE_ROWS_PER_WEEK){
          const tr = makeEmptyRow('placeholder-note');
          tbl.tBodies[0].insertBefore(tr, allRows()[next] || null);
        }
      });
    });
  }

  /* ===== 폰트 초기화/축소 ===== */
  function resetFonts(){
    document.querySelectorAll('.table-wrap table td .cell').forEach(cell => {
      cell.style.fontSize  = MAX_FONT_PX + 'px';
      cell.style.lineHeight = '1.15';
      // 클램프 해제
      cell.style.display = '';
      cell.style.webkitBoxOrient = '';
      cell.style.webkitLineClamp = '';
      cell.style.overflow = '';
    });
  }

  function shrinkAllText(){
    document.querySelectorAll('.table-wrap table tr:not([data-weekrow="1"]) td .cell').forEach(el => shrinkToFit(el, MIN_FONT_PX));
  }

  function shrinkToFit(el, minPx){
    if (!el.textContent.trim() && el.children.length === 0) return;
    let fs = parseFloat(getComputedStyle(el).fontSize) || MAX_FONT_PX;

    for (let i=0; i<12; i++){
      const fitsH = el.scrollHeight <= el.clientHeight;
      const fitsW = el.scrollWidth  <= el.clientWidth;
      if (fitsH && fitsW) break;

      const hRatio = el.clientHeight / Math.max(el.scrollHeight, 1);
      const wRatio = el.clientWidth  / Math.max(el.scrollWidth, 1);
      const ratio  = Math.max(0.5, Math.min(hRatio, wRatio)) * 0.98;

      const next = Math.max(minPx, Math.floor(fs * ratio));
      if (next >= fs) break;
      fs = next;
      el.style.fontSize  = fs + 'px';
      el.style.lineHeight = (0.95 + (fs - minPx) * 0.02).toFixed(2);
      if (fs <= minPx) break;
    }

    // 최저 폰트까지 내려도 넘치면 줄수로 잘라내기(클램프)
    if (el.scrollHeight > el.clientHeight || el.scrollWidth > el.clientWidth){
      const cs = getComputedStyle(el);
      const lh = parseFloat(cs.lineHeight) || (parseFloat(cs.fontSize) * 1.15) || 12;
      const maxLines = Math.max(1, Math.floor(el.clientHeight / lh));
      el.style.display = '-webkit-box';
      el.style.webkitBoxOrient = 'vertical';
      el.style.webkitLineClamp = String(maxLines);
      el.style.overflow = 'hidden';
    }
  }

  /* ===== 균일 높이 배분(요일/날짜/스케줄4/기타1) ===== */
  function unifyWeeksByTypeHeights(){
    const tables = Array.from(document.querySelectorAll('.table-wrap table'));
    if (!tables.length) return;

    const isNoteRow = (tr)=>{
      const tds = Array.from(tr.querySelectorAll('td'));
      let red=0, span=0;
      tds.forEach(td=>{
        const s=td.colSpan||1;
        const bg = getComputedStyle(td).backgroundColor || td.style.backgroundColor;
        span+=s; if (isReddish(bg)) red+=s;
      });
      return span && (red/span)>=0.5;
    };

    const getWeekBlock = (rows, startIdx, nextStartIdx)=>{
      const start = startIdx + 1, end = (nextStartIdx ?? rows.length);
      const body  = rows.slice(start, end);
      const schedRows = body.filter(tr => !isNoteRow(tr)).slice(0, SCHEDULE_ROWS_PER_WEEK);
      const noteRows  = body.filter(tr =>  isNoteRow(tr)).slice(0, NOTE_ROWS_PER_WEEK);
      return { schedRows, noteRows };
    };

    tables.forEach(tbl=>{
      const rows = Array.from(tbl.querySelectorAll('tr'));
      const weekStarts = rows.map((tr,i)=> tr.dataset.weekrow==='1' ? i : -1).filter(i=>i>=0);
      const weeks = weekStarts.length;
      if (!weeks) return;

      const wrap = tbl.closest('.table-wrap');
      const wrapH = wrap ? wrap.clientHeight : tbl.parentElement.clientHeight;

      const css = getComputedStyle(tbl);
      const weeknumH = parseFloat(css.getPropertyValue('--weeknum-h')) || 10;
      const dowH     = parseFloat(css.getPropertyValue('--dow-h'))     || 10;

      const hasDow   = rows.length && rows[0].dataset.dowrow === '1';
      const headerH  = (hasDow ? dowH : 0) + (weeks * weeknumH);

      const avail = Math.max(50, wrapH - headerH);
      const scaledAvail = Math.floor(avail * WEEK_HEIGHT_SCALE);

      // 주당 기본 높이를 5칸(스케줄4+기타1)으로 동일 분할
      const perWeekBase = Math.floor(scaledAvail / weeks);
      const unitPerWeek = SCHEDULE_ROWS_PER_WEEK + NOTE_ROWS_PER_WEEK; // 5
      const unitH = Math.max(12, Math.floor(perWeekBase / unitPerWeek));
      let leftover = perWeekBase - unitH * unitPerWeek;

      weekStarts.forEach((ws, idx)=>{
        const next = weekStarts[idx+1];
        const { schedRows, noteRows } = getWeekBlock(rows, ws, next);

        // 스케줄 4줄 동일
        schedRows.forEach(tr=>{
          tr.style.height = `${unitH}px`;
          tr.querySelectorAll('td').forEach(td=> td.style.height = '100%');
        });

        // 기타 1줄 = unitH + 잔여(있으면 1px씩)
        const noteH = unitH + (leftover>0 ? 1 : 0);
        if (leftover>0) leftover--;

        noteRows.forEach(tr=>{
          tr.style.height = `${noteH}px`;
          tr.querySelectorAll('td').forEach(td=> td.style.height = '100%');
        });
      });
    });
  }

  /* ===== 공통 ===== */
  function setLoading(msg){ $status.textContent = msg || ''; }
  function showError(e){ console.error(e); setLoading(`오류: ${e?.message || e}`); }
  function esc(s){
    const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
    return String(s).replace(/[&<>"']/g, ch => map[ch]);
  }
</script>
</body>
</html>
