<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>월간 스케줄</title>
<style>
  /* ===== 전역 설정 ===== */
  :root{
    /* 고정 줄 높이(px) — 모든 팀 동일, 살짝 더 줄임 */
    --dow-h: 16px;    /* 요일줄 */
    --date-h: 18px;   /* 날짜줄 */
    --note-h: 22px;   /* 빨간 기타줄 */

    --cell-pad: 4px 6px;
    --cell-font: 12px;
    --cell-line: 1.15;

    /* JS가 계산해서 넣는 가용 높이 */
    --usableH: 100vh;
  }

  html, body{
    height:100%; margin:0; overflow:hidden;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
    color:#222; background:#fff;
  }

  /* 공통 상단바 */
  .nav{
    background:#2c3e50; color:#fff; padding:10px;
    display:flex; justify-content:flex-end; gap:10px;
    position:sticky; top:0; z-index:1000;
  }
  .nav button{ background:#fff; color:#000; border:none; border-radius:4px; padding:6px 12px; cursor:pointer; }

  /* 페이지 상단 컨트롤 */
  #top-bar{
    background:#f7f7f8; border-bottom:1px solid #e5e7eb; padding:8px 14px;
    display:flex; align-items:center; gap:10px; position:sticky; top:0; z-index:900;
  }
  #top-bar h1{ margin:0; font-size:18px; }
  #top-bar select, #top-bar button{
    padding:5px 10px; font-size:14px; border:1px solid #dcdcdc; border-radius:8px; background:#fff;
  }
  #status{ color:#666; font-size:13px; margin-left:4px; }

  /* ===== 본문 영역 ===== */
  .page{
    height: var(--usableH);           /* nav+top-bar 뺀 실가용 높이 */
    overflow:auto;
    padding: 6px 10px 2px;            /* ← 변경: 하단 여백 더 줄임(6→2) */
    box-sizing:border-box;
    scroll-snap-type:y mandatory;
  }

  /* 한 화면 = 한 팀 */
  .team{
    scroll-snap-align:start;
    border:1px solid #e5e7eb; border-radius:12px; background:#fff;
    box-shadow:0 1px 4px rgba(0,0,0,.04);
    display:flex; flex-direction:column;
    height: var(--usableH);           /* 뷰포트에 정확히 맞춤 */
    margin:0;                         /* 아래 마진 제거 */
    overflow:hidden;
  }
  .teambar{ background:#e9eef5; border-bottom:1px solid #dbe2ea; color:#1f2937; font-size:12px; font-weight:700; padding:8px 12px; }

  .table-wrap{ flex:1 1 auto; overflow:hidden; }

  /* ===== 캘린더 표 ===== */
  table{
    width:100%; height:100%; table-layout:fixed; border-collapse:collapse;
  }
  td{
    border:1px solid #e6e6e6; padding:var(--cell-pad); vertical-align:top;
    font-size:var(--cell-font); line-height:var(--cell-line); box-sizing:border-box;
    overflow:hidden;
  }
  td>.cell{ height:100%; overflow:hidden; }

  /* 고정 높이 줄들 */
  tr[data-dow="1"]{ height:var(--dow-h); background:#f3f4f6; }
  tr[data-dow="1"] td{ padding:0 4px; font-size:11px; font-weight:600; text-align:center; }
  tr[data-dow="1"] td .cell{ height:var(--dow-h); line-height:var(--dow-h); white-space:nowrap; text-overflow:ellipsis; }

  tr[data-date="1"]{ height:var(--date-h); }
  tr[data-date="1"] td{ padding:0 4px; text-align:center; font-weight:600; }
  tr[data-date="1"] td .cell{ height:var(--date-h); line-height:var(--date-h); white-space:nowrap; }

  tr[data-note="1"]{ height:var(--note-h); }    /* 기타(빨간) 줄 */

  /* 스케줄 줄(가변) — JS가 6주 균등 분배로 height 픽셀 지정 */
  tr[data-sched="1"]{ }

  /* placeholder 행(빈 줄 채움) 배경 */
  tr.placeholder-sched td{ background:#fff; }
  tr.placeholder-note  td{ background:#fde8e8; } /* 연한 빨강 */
</style>
</head>
<body>
  <div class="nav" id="nav">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='monthly.html'">월별 대상처 리스트</button>
    <button onclick="location.href='map.html'">지도 보기</button>
    <button onclick="location.href='schedule.html'">스케줄</button>
  </div>

  <div id="top-bar">
    <h1>월간 스케줄</h1>
    <label for="sheetSelect"><strong>월 선택:</strong></label>
    <select id="sheetSelect"></select>
    <button id="refreshBtn">새로고침</button>
    <span id="status"></span>
  </div>

  <div class="page" id="page"><!-- 팀별 섹션이 JS로 들어옴 --></div>

<script>
/* ============ 옵션 ============ */
const SCHEDULE_ROWS_PER_WEEK = 4;     // 스케줄 줄(주당)
const NOTE_ROWS_PER_WEEK     = 1;     // 기타(빨간) 줄(주당)
const WEEKS_FIXED            = 6;     // 항상 6주로 균등 분배
const MIN_FONT_PX            = 9;
const API = (qs) => `/api/schedule${qs?('?' + qs):''}`;

/* ============ 엘리먼트 ============ */
const $page    = document.getElementById('page');
const $select  = document.getElementById('sheetSelect');
const $refresh = document.getElementById('refreshBtn');
const $status  = document.getElementById('status');

/* ============ 진입 ============ */
init().catch(showError);

async function init(){
  /* 시트 목록 (간단 캐시) */
  let sheets = null;
  try{
    const cached = JSON.parse(sessionStorage.getItem('sheets:v1')||'null');
    if (cached && Date.now()-cached.t < 5*60*1000) sheets = cached.list;
  }catch(_){}
  if (!sheets){
    const j = await getJson(API('mode=sheets'));
    sheets = j.sheets || [];
    sessionStorage.setItem('sheets:v1', JSON.stringify({t:Date.now(), list:sheets}));
  }

  const now = new Date();
  const initMonth = `${now.getMonth()+1}월`;

  $select.innerHTML = sheets.map(n => `<option value="${esc(n)}">${esc(n)}</option>`).join('');
  $select.value = sheets.includes(initMonth) ? initMonth : (sheets[0] || '1월');

  $select.addEventListener('change', () => render($select.value));
  $refresh.addEventListener('click', () => render($select.value));

  await render($select.value);
  window.addEventListener('resize',() => relayout());
  relayout();
}

/* === 뷰포트 가용 높이 계산해서 --usableH 세팅 (하단 여백 제거) === */
function relayout(){
  const nav  = document.getElementById('nav');
  const top  = document.getElementById('top-bar');
  const usable = Math.max(
    200,
    window.innerHeight - (nav?.offsetHeight||0) - (top?.offsetHeight||0)
  );
  document.documentElement.style.setProperty('--usableH', usable + 'px');

  // 팀 카드가 페이지 패딩을 제외한 영역을 꽉 채우도록
  const cs   = getComputedStyle($page);
  const pt   = parseFloat(cs.paddingTop)||0;
  const pb   = parseFloat(cs.paddingBottom)||0;
  const teamH = usable - pt - pb;
  document.querySelectorAll('.team').forEach(el => { el.style.height = teamH + 'px'; });

  // 높이 재분배 및 텍스트 보정
  fixAllHeights();
  clampAllCells();
}

/* ============ 렌더링 메인 ============ */
async function render(sheetName){
  setLoading(`${sheetName} 불러오는 중…`);
  const data = await getJson(API(new URLSearchParams({mode:'month', sheet:sheetName}).toString()));
  if (!data?.ok) throw new Error(data?.error || 'API 오류');

  $page.innerHTML = '';
  const year = data.year || (new Date()).getFullYear();

  for(const team of data.teams){
    $page.appendChild(renderTeam(team, {sheetName, year}));
  }

  // 구조 정규화(주당 4+1 고정) 후 높이 계산
  normalizeAllTables();
  relayout();          // 가용 높이 재계산 → fixAllHeights 내부 호출
  setLoading('');
}

/* ============ 팀 섹션 만들기 ============ */
function renderTeam(team, {sheetName, year}={}){
  const wrap = document.createElement('section'); wrap.className='team';
  const bar  = document.createElement('div'); bar.className='teambar'; bar.textContent = `${team.id}팀`;
  const tw   = document.createElement('div'); tw.className='table-wrap';
  const tbl  = document.createElement('table');

  // 시트에서 넘어온 그리드(병합 포함) 복원
  const grid = Array.from({length: team.rows}, () => Array(team.cols).fill(null));
  team.cells.forEach(cell=>{
    const r0 = cell.r-1, c0 = cell.c-1;
    grid[r0][c0] = cell;
    const rs = cell.rowspan||1, cs = cell.colspan||1;
    for(let r=r0;r<r0+rs;r++){
      for(let c=c0;c<c0+cs;c++){
        if (r===r0 && c===c0) continue;
        grid[r][c]='skip';
      }
    }
  });

  // 요일줄/날짜숫자줄 탐지
  const isDowRow = (row)=> {
    const KR=['일','월','화','수','목','금','토']; const EN=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    let hit=0,total=0;
    for (let c=0;c<team.cols;c++){
      const cell = row[c]; if(cell==='skip') continue; total++;
      const t = visibleText(cell);
      if (KR.some(x=>t.includes(x)) || EN.some(x=>t.includes(x))) hit++;
    }
    return total && hit >= Math.max(5, Math.floor(total*0.6));
  };
  const isDateNumRow = (row) => {
    let d=0,total=0;
    for(let c=0;c<team.cols;c++){
      const cell=row[c]; if(cell==='skip') continue; total++;
      const t = visibleText(cell);
      if (/^\d{1,2}$/.test(t)) d++;
    }
    return total && d >= Math.max(5, Math.floor(total*0.6));
  };

  for (let r=0;r<team.rows;r++){
    const tr = document.createElement('tr');

    if (r===0 && isDowRow(grid[r])) tr.dataset.dow = '1';
    if (isDateNumRow(grid[r]))      tr.dataset.date = '1';

    for (let c=0;c<team.cols;c++){
      const cell = grid[r][c];
      if (cell==='skip') continue;

      const td = document.createElement('td');

      if (cell){
        if (cell.rowspan>1) td.rowSpan = cell.rowspan;
        if (cell.colspan>1) td.colSpan = cell.colspan;
        if (cell.bg) td.style.backgroundColor = cell.bg;

        const t = visibleText(cell);
        if (cell.html && t !== '') td.innerHTML = cell.html;
        else { if (cell.fc) td.style.color = cell.fc; td.textContent = t; }
      }

      let box = td.querySelector('.cell');
      if(!box){
        box=document.createElement('div'); box.className='cell';
        while(td.firstChild) box.appendChild(td.firstChild);
        td.appendChild(box);
      }
      tr.appendChild(td);
    }
    tbl.appendChild(tr);
  }

  tw.appendChild(tbl);
  wrap.appendChild(bar);
  wrap.appendChild(tw);
  return wrap;
}

/* ============ 구조 정규화 (주당 4 스케줄 + 1 기타 고정) ============ */
function normalizeAllTables(){
  document.querySelectorAll('.table-wrap table').forEach(tbl=>{
    const rows = ()=> Array.from(tbl.querySelectorAll('tr'));
    let arr = rows();

    const weekStarts = arr.map((tr,i)=> tr.dataset.date==='1' ? i : -1).filter(i=>i>=0);
    if (!weekStarts.length) return;

    const cols = Math.max(...arr.map(tr => tr.querySelectorAll('td').length)) || 7;

    const isNoteRow = (tr)=>{
      const tds = Array.from(tr.querySelectorAll('td'));
      let red=0, span=0;
      tds.forEach(td=>{
        const s=td.colSpan||1; span+=s;
        const bg = getComputedStyle(td).backgroundColor || td.style.backgroundColor;
        if (isReddish(bg)) red+=s;
      });
      return span && (red/span)>=0.5;
    };

    const makeRow = (className)=>{
      const tr=document.createElement('tr'); if(className) tr.className=className;
      for(let i=0;i<cols;i++){
        const td=document.createElement('td'); const box=document.createElement('div'); box.className='cell';
        td.appendChild(box); tr.appendChild(td);
      }
      return tr;
    };

    weekStarts.forEach((ws,idx)=>{
      arr = rows();
      const end = weekStarts[idx+1] ?? arr.length;
      const block = arr.slice(ws+1, end);

      let sched = block.filter(tr=> !isNoteRow(tr));
      let note  = block.filter(tr=>  isNoteRow(tr));

      // 스케줄 줄 과다 → 4번째 줄에 병합
      if (sched.length > SCHEDULE_ROWS_PER_WEEK){
        const keep = sched.slice(0, SCHEDULE_ROWS_PER_WEEK);
        for (let i=SCHEDULE_ROWS_PER_WEEK;i<sched.length;i++){
          mergeRowInto(sched[i], keep[SCHEDULE_ROWS_PER_WEEK-1]);
        }
      }

      // 부족 → 빈 스케줄 줄 추가
      arr = rows();
      const freshBlock = arr.slice(ws+1, end);
      let freshSched = freshBlock.filter(tr=> !isNoteRow(tr));
      let freshNote  = freshBlock.filter(tr=>  isNoteRow(tr));
      while (freshSched.length < SCHEDULE_ROWS_PER_WEEK){
        const tr = makeRow('placeholder-sched'); tr.dataset.sched='1';
        tbl.tBodies[0].insertBefore(tr, freshNote[0] || arr[end] || null);
        arr = rows();
        const fb = arr.slice(ws+1, end);
        freshSched = fb.filter(tr=> !isNoteRow(tr));
        freshNote  = fb.filter(tr=>  isNoteRow(tr));
      }

      // 노트는 정확히 1줄
      if (freshNote.length === 0){
        const tr = makeRow('placeholder-note'); tr.dataset.note='1';
        tbl.tBodies[0].insertBefore(tr, arr[end] || null);
      }else{
        freshNote[0].dataset.note='1';
        for (let i=1;i<freshNote.length;i++){
          mergeRowInto(freshNote[i], freshNote[0]);
        }
      }

      // 스케줄 줄 마킹
      arr = rows();
      const finalBlock = arr.slice(ws+1, end);
      finalBlock.forEach(tr=>{
        if (tr.dataset.note==='1') return;
        tr.dataset.sched='1';
      });
    });
  });

  function mergeRowInto(src, dst){
    const dT = dst.querySelectorAll('td');
    const sT = src.querySelectorAll('td');
    const n = Math.min(dT.length, sT.length);
    for (let j=0;j<n;j++){
      const dstBox = ensureCell(dT[j]);
      const srcBox = sT[j].querySelector('.cell') || sT[j];
      const html = srcBox.innerHTML.trim();
      if (html){
        const div=document.createElement('div'); div.className='it'; div.innerHTML=html;
        dstBox.appendChild(div);
      }
    }
    src.remove();
  }
}

/* ============ 높이 계산: 고정 줄 + 남은 영역을 6주로 균등 분배 ============ */
function fixAllHeights(){
  document.querySelectorAll('.team .table-wrap').forEach(wrap=>{
    const tbl = wrap.querySelector('table'); if (!tbl) return;

    const rows = Array.from(tbl.querySelectorAll('tr'));
    const weekStarts = rows.map((tr,i)=> tr.dataset.date==='1' ? i : -1).filter(i=>i>=0);
    if (!weekStarts.length) return;

    const dowH   = parseFloat(getCss(tbl, '--dow-h'))  || 0;
    const dateH  = parseFloat(getCss(tbl, '--date-h')) || 0;
    const noteH  = parseFloat(getCss(tbl, '--note-h')) || 0;

    const hasDow = rows[0]?.dataset.dow === '1';

    /* 헤더(요일 + 각 주의 날짜/노트) 높이는 고정값으로 계산하되,
       분배 대상은 항상 6주(WEEKS_FIXED). */
    const headerFixedTarget =
      (hasDow ? dowH : 0) + (WEEKS_FIXED * (dateH + noteH));

    const wrapH = wrap.clientHeight;

    /* 경계선/반올림 오차 보정 */
    const FUDGE = 2; /* ← 변경: 10→2 로 줄여 거의 꽉 차게 */

    const totalSchedAvail = Math.max(40, wrapH - headerFixedTarget - FUDGE);
    const perWeekBodyInt  = Math.floor(totalSchedAvail / WEEKS_FIXED);  // 주당 스케줄 영역
    const schedBaseH      = Math.max(12, Math.floor(perWeekBodyInt / SCHEDULE_ROWS_PER_WEEK));
    const perWeekLeftover = perWeekBodyInt - (schedBaseH * SCHEDULE_ROWS_PER_WEEK);

    // 실제 DOM 상 존재하는 주 블록마다 동일 규칙 적용
    weekStarts.forEach((ws, idx)=>{
      const next = weekStarts[idx+1] ?? rows.length;
      const block = rows.slice(ws+1, next);

      // 날짜/노트/스케줄 줄 분리
      const noteRow = block.find(tr => tr.dataset.note==='1');
      const schedRows = block.filter(tr => tr.dataset.sched==='1').slice(0, SCHEDULE_ROWS_PER_WEEK);

      // 고정 줄 높이 지정
      rows[ws].style.height = `${dateH}px`;            // 날짜줄
      if (noteRow) noteRow.style.height = `${noteH}px`; // 노트줄

      // 스케줄 줄(4줄) 균등 배분 + 남는 픽셀 앞쪽 1px씩
      let spill = perWeekLeftover;
      schedRows.forEach(tr=>{
        const h = schedBaseH + (spill>0 ? 1 : 0);
        if (spill>0) spill--;
        tr.style.height = `${h}px`;
        tr.querySelectorAll('td,.cell').forEach(el=> el.style.height='100%');
      });
    });

    // 요일줄 고정
    if (hasDow){
      const first = rows[0];
      first.style.height = `${dowH}px`;
      first.querySelectorAll('td .cell').forEach(c=>{ c.style.height = `${dowH}px`; c.style.lineHeight = `${dowH}px`; });
    }
  });
}

/* ============ 텍스트 오버플로우 처리 (줄 수 제한) ============ */
function clampAllCells(){
  document.querySelectorAll('tr[data-sched="1"] td .cell, tr[data-note="1"] td .cell')
    .forEach(el => shrinkToFit(el, MIN_FONT_PX));
}

/* ============ 유틸들 ============ */
async function getJson(url){
  const r = await fetch(url, {cache:'no-store'});
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
function setLoading(msg){ $status.textContent = msg || ''; }
function showError(e){ console.error(e); setLoading(`오류: ${e?.message || e}`); }

function esc(s){
  const map = {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"};
  return String(s).replace(/[&<>"']/g, ch => map[ch]);
}
function visibleText(cell){
  if (cell?.html){
    return String(cell.html).replace(/<br\s*\/?>/gi,' ')
                            .replace(/&nbsp;/gi,' ')
                            .replace(/<[^>]*>/g,'')
                            .trim();
  }
  return String(cell?.text ?? '').trim();
}
function isReddish(c){
  if(!c) return false;
  c=String(c).trim().toLowerCase();
  if (c.startsWith('#')){
    if (c==='#f00' || c==='#ff0000') return true;
    if (c.length===7){
      const r=parseInt(c.slice(1,3),16), g=parseInt(c.slice(3,5),16), b=parseInt(c.slice(5,7),16);
      return (r>=200 && r>g && r>b);
    }
  }
  const m=c.match(/rgba?\((\d+)[,\s]+(\d+)[,\s]+(\d+)/);
  if (m){ const r=+m[1], g=+m[2], b=+m[3]; return (r>=200 && r>g && r>b); }
  return false;
}
function ensureCell(td){
  let box = td.querySelector('.cell');
  if(!box){ box=document.createElement('div'); box.className='cell';
    while(td.firstChild) box.appendChild(td.firstChild); td.appendChild(box); }
  return box;
}
function getCss(el, varName){
  const v = getComputedStyle(el).getPropertyValue(varName);
  return (v||'').replace('px','').trim();
}
function shrinkToFit(el, minPx){
  if (!el.textContent.trim() && el.children.length===0) return;
  el.style.fontSize = '';
  el.style.lineHeight = '';
  let fs = parseFloat(getComputedStyle(el).fontSize) || 12;
  for (let i=0;i<10;i++){
    const fitsH = el.scrollHeight <= el.clientHeight;
    const fitsW = el.scrollWidth  <= el.clientWidth;
    if (fitsH && fitsW) break;
    fs = Math.max(minPx, Math.floor(fs * 0.92));
    el.style.fontSize  = fs + 'px';
    el.style.lineHeight = (0.95 + (fs - minPx) * 0.02).toFixed(2);
    if (fs <= minPx) break;
  }
  if (el.scrollHeight > el.clientHeight || el.scrollWidth > el.clientWidth){
    const cs = getComputedStyle(el);
    const lh = parseFloat(cs.lineHeight) || (parseFloat(cs.fontSize) * 1.15) || 12;
    const maxLines = Math.max(1, Math.floor(el.clientHeight / lh));
    el.style.display = '-webkit-box';
    el.style.webkitBoxOrient = 'vertical';
    el.style.webkitLineClamp = String(maxLines);
    el.style.overflow = 'hidden';
  }
}
</script>
</body>
</html>
